{% extends 'base.html' %}
{% load static %}

{% block title %}Command Center{% endblock %}

{% block breadcrumbs %}
<span class="text-zinc-500 dark:text-gray-600">/</span>
<span>command-center</span>
{% endblock %}

{% block content %}
<div class="max-w-[1920px] mx-auto px-6 py-8">
    <!-- Top Section: Grade + Key Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Security Grade (Top Left) -->
        <div class="lg:col-span-1 bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-8 flex flex-col items-center justify-center shadow-sm dark:shadow-none">
            <div class="text-xs font-mono text-zinc-500 dark:text-gray-500 uppercase mb-4 tracking-wider">Security Grade</div>
            <div class="text-9xl font-bold {% if security_grade == 'A' %}text-emerald-600 dark:text-emerald-400{% elif security_grade == 'B' %}text-emerald-500 dark:text-emerald-300{% elif security_grade == 'C' %}text-yellow-500 dark:text-yellow-400{% else %}text-red-600 dark:text-red-500{% endif %} drop-shadow-lg {% if security_grade == 'A' %}drop-shadow-emerald-500/50{% elif security_grade == 'B' %}drop-shadow-emerald-400/50{% elif security_grade == 'C' %}drop-shadow-yellow-500/50{% else %}drop-shadow-red-500/50{% endif %}">
                {{ security_grade }}
            </div>
            <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono mt-4">Score: {{ grade_score|floatformat:0 }}/100</div>
        </div>

        <!-- Key Metrics (Top Right) -->
        <div class="lg:col-span-2 bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 shadow-sm dark:shadow-none">
            <div class="text-xs font-mono text-zinc-500 dark:text-gray-500 uppercase mb-6 tracking-wider">Key Metrics</div>
            <div class="grid grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-4xl font-bold {% if critical_high > 0 %}text-red-600 dark:text-red-400{% else %}text-emerald-600 dark:text-emerald-400{% endif %} mb-2">
                        {{ critical_high }}
                    </div>
                    <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono uppercase">Criticals</div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold {% if secrets_count > 0 %}text-red-600 dark:text-red-400{% else %}text-emerald-600 dark:text-emerald-400{% endif %} mb-2">
                        {{ secrets_count }}
                    </div>
                    <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono uppercase">Secrets</div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold {% if mttr_days <= 7 %}text-emerald-600 dark:text-emerald-400{% elif mttr_days <= 14 %}text-yellow-500 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %} mb-2">
                        {{ mttr_days|floatformat:0 }}
                    </div>
                    <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono uppercase">MTTR (days)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remediation Heatmap (Middle) -->
    <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 mb-8 shadow-sm dark:shadow-none">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-lg font-bold text-zinc-900 dark:text-white mb-1">Security Velocity</h2>
                <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono">Remediation Heatmap (Last 90 Days)</div>
            </div>
            <div class="flex items-center gap-4 text-xs text-zinc-500 dark:text-gray-500 font-mono">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-emerald-600 dark:bg-emerald-500 rounded"></div>
                    <span>Fixed</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-zinc-200 dark:bg-zinc-800 rounded"></div>
                    <span>No Activity</span>
                </div>
            </div>
        </div>
        
        <!-- Scrollable Heatmap Container -->
        <div class="overflow-x-auto pb-4">
            <div class="inline-flex gap-1 min-w-max">
                {% for day in heatmap_data %}
                <div class="flex flex-col items-center gap-1">
                    <div 
                        class="w-3 h-3 rounded {% if day.is_green %}bg-emerald-600 dark:bg-emerald-500{% else %}bg-zinc-200 dark:bg-zinc-800{% endif %} {% if day.is_green %}hover:bg-emerald-700 dark:hover:bg-emerald-400{% else %}hover:bg-zinc-300 dark:hover:bg-zinc-700{% endif %} transition-colors cursor-pointer border border-zinc-300 dark:border-zinc-900"
                        title="{{ day.date }}: {{ day.fixed_count }} finding{{ day.fixed_count|pluralize }} fixed"
                    ></div>
                    {% if forloop.counter0|divisibleby:7 or forloop.first %}
                    <div class="text-[8px] text-zinc-600 dark:text-gray-600 font-mono mt-1">{{ day.day_of_week }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="text-xs text-zinc-600 dark:text-gray-600 font-mono mt-4 text-center">
            Scroll horizontally to view full timeline
        </div>
    </div>

    <!-- Action List (Bottom) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left: Vulnerabilities (CVEs) -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 shadow-sm dark:shadow-none">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-lg font-bold text-zinc-900 dark:text-white mb-1">Vulnerabilities</h2>
                    <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono">Upgrade Versions</div>
                </div>
                <a href="{% url 'vulnerabilities_list' %}" class="text-xs text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 font-mono uppercase tracking-wider">
                    View All →
                </a>
            </div>
            
            <div class="space-y-3 max-h-[600px] overflow-y-auto">
                {% for vuln in top_vulnerabilities %}
                <div class="bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 rounded p-4 hover:border-zinc-300 dark:hover:border-zinc-700 transition-colors">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2.5 py-0.5 rounded-md text-xs font-medium border
                                    {% if vuln.severity == 'CRITICAL' %}bg-red-50 dark:bg-red-500/20 text-red-700 dark:text-red-400 border-red-200 dark:border-red-500/30
                                    {% elif vuln.severity == 'HIGH' %}bg-orange-50 dark:bg-orange-500/20 text-orange-700 dark:text-orange-400 border-orange-200 dark:border-orange-500/30
                                    {% elif vuln.severity == 'MEDIUM' %}bg-yellow-50 dark:bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-500/30
                                    {% elif vuln.severity == 'LOW' %}bg-blue-50 dark:bg-blue-500/20 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-500/30
                                    {% else %}bg-zinc-100 dark:bg-gray-500/20 text-zinc-700 dark:text-gray-400 border-zinc-200 dark:border-gray-500/30{% endif %}">
                                    {{ vuln.severity }}
                                </span>
                                <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.vulnerability_id }}" target="_blank" class="text-sm font-mono text-zinc-900 dark:text-white hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
                                    {{ vuln.vulnerability_id }}
                                </a>
                            </div>
                            <div class="text-xs text-zinc-600 dark:text-gray-400 mb-2 line-clamp-1">{{ vuln.title|default:"No description" }}</div>
                            <div class="flex items-center gap-4 text-xs font-mono">
                                <div>
                                    <span class="text-zinc-500 dark:text-gray-500">Package:</span>
                                    <span class="text-zinc-900 dark:text-white ml-1">{{ vuln.package_name|default:"N/A" }}</span>
                                </div>
                                <div>
                                    <span class="text-zinc-500 dark:text-gray-500">Current:</span>
                                    <span class="text-red-600 dark:text-red-400 ml-1">{{ vuln.package_version|default:"N/A" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if vuln.fix_version %}
                    <div class="mt-2 pt-2 border-t border-zinc-200 dark:border-zinc-800">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-zinc-500 dark:text-gray-500 font-mono">Upgrade to:</span>
                            <span class="text-xs font-mono text-emerald-600 dark:text-emerald-400 font-bold">{{ vuln.fix_version }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-2 pt-2 border-t border-zinc-200 dark:border-zinc-800">
                        <span class="text-xs text-zinc-600 dark:text-gray-600 font-mono">No fix version available</span>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center text-zinc-500 dark:text-gray-500 text-sm py-12 font-mono">
                    No active vulnerabilities
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right: Secrets (API Keys) -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 shadow-sm dark:shadow-none">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-lg font-bold text-zinc-900 dark:text-white mb-1">Secrets</h2>
                    <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono">File Paths</div>
                </div>
                <a href="{% url 'vulnerabilities_list' %}?finding_type=SECRET" class="text-xs text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 font-mono uppercase tracking-wider">
                    View All →
                </a>
            </div>
            
            <div class="space-y-3 max-h-[600px] overflow-y-auto">
                {% for secret in top_secrets %}
                <div class="bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 rounded p-4 hover:border-zinc-300 dark:hover:border-zinc-700 transition-colors">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2.5 py-0.5 rounded-md text-xs font-medium border bg-red-50 dark:bg-red-500/20 text-red-700 dark:text-red-400 border-red-200 dark:border-red-500/30">
                                    {{ secret.severity }}
                                </span>
                                <span class="text-sm font-mono text-zinc-900 dark:text-white">{{ secret.title|truncatewords:8 }}</span>
                            </div>
                            <div class="text-xs text-zinc-600 dark:text-gray-400 mb-2 line-clamp-1">
                                {% if secret.metadata.secret_preview %}
                                    Secret: {{ secret.metadata.secret_preview|default:"Secret detected" }}
                                {% else %}
                                    Secret detected
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-zinc-200 dark:border-zinc-800">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-zinc-500 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span class="text-xs font-mono text-emerald-600 dark:text-emerald-400 flex-1 truncate">{{ secret.file_path }}</span>
                            {% if secret.line_number > 0 %}
                            <span class="text-xs text-zinc-600 dark:text-gray-600 font-mono">:{{ secret.line_number }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-zinc-500 dark:text-gray-500 text-sm py-12 font-mono">
                    No active secrets
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Heatmap Data -->
{{ heatmap_data|json_script:"heatmap-data" }}

<script>
// Heatmap interaction (optional enhancement)
document.addEventListener('DOMContentLoaded', function() {
    const heatmapSquares = document.querySelectorAll('[title*="fixed"]');
    heatmapSquares.forEach(square => {
        square.addEventListener('mouseenter', function() {
            // Could add tooltip or highlight effect here
        });
    });
});
</script>
{% endblock %}
