{% extends 'base.html' %}

{% block breadcrumbs %}
<span class="text-gray-600">/</span>
<a href="{% url 'product_list' %}" class="hover:text-white">products</a>
<span class="text-gray-600">/</span>
<span class="text-white">{{ title|default:"create" }}</span>
{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto mt-10">
    <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-8 shadow-2xl">
        
        <div class="mb-6">
            <h1 class="text-xl font-bold text-zinc-900 dark:text-white">{{ title|default:"Register New Product" }}</h1>
            <p class="text-xs text-zinc-500 dark:text-gray-500 font-mono mt-1">Define asset governance levels.</p>
        </div>

        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="bg-{% if message.tags == 'error' %}red{% else %}green{% endif %}-50 dark:bg-{% if message.tags == 'error' %}red{% else %}green{% endif %}-900/20 border border-{% if message.tags == 'error' %}red{% else %}green{% endif %}-200 dark:border-{% if message.tags == 'error' %}red{% else %}green{% endif %}-800 rounded-lg p-4">
                <p class="text-{% if message.tags == 'error' %}red{% else %}green{% endif %}-600 dark:text-{% if message.tags == 'error' %}red{% else %}green{% endif %}-400 text-sm">{{ message }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" class="space-y-6" id="productForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
                <ul class="text-red-600 dark:text-red-400 text-sm">
                    {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div>
                <label class="block text-[10px] font-mono text-zinc-500 dark:text-gray-500 uppercase tracking-widest mb-2">Owning Workspace *</label>
                {{ form.workspace }}
                {% if form.workspace.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.workspace.errors.0 }}</p>
                {% endif %}
                <p class="text-[10px] text-zinc-500 dark:text-gray-500 mt-1">Select workspace first to see available teams</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-mono text-zinc-500 dark:text-gray-500 uppercase tracking-widest mb-2">Product Name *</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label class="block text-[10px] font-mono text-zinc-500 dark:text-gray-500 uppercase tracking-widest mb-2">Asset Type *</label>
                    {{ form.product_type }}
                    {% if form.product_type.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.product_type.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <div>
                <label class="block text-[10px] font-mono text-zinc-500 dark:text-gray-500 uppercase tracking-widest mb-2">Description</label>
                {{ form.description }}
                {% if form.description.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                {% endif %}
            </div>

            <div>
                <label class="block text-[10px] font-mono text-zinc-500 dark:text-gray-500 uppercase tracking-widest mb-2">Business Criticality *</label>
                {{ form.criticality }}
                {% if form.criticality.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.criticality.errors.0 }}</p>
                {% endif %}
                <p class="text-[10px] text-zinc-600 dark:text-gray-600 mt-2 leading-relaxed">
                    <strong class="text-red-500">Critical:</strong> Core Revenue / PII Data.<br>
                    <strong class="text-orange-500">High:</strong> Internal Business Logic.<br>
                    <strong class="text-yellow-500">Medium:</strong> Support Tools.<br>
                    <strong class="text-blue-500">Low:</strong> Experimental / Sandbox.
                </p>
            </div>

            <div>
                <label class="block text-[10px] font-mono text-zinc-500 dark:text-gray-500 uppercase tracking-widest mb-2">Assigned Teams <span class="text-zinc-400 dark:text-gray-600 normal-case">(optional)</span></label>
                <select name="teams" id="id_teams" multiple class="cra-input" size="5">
                    {% if form.teams.field.queryset.count > 0 %}
                        {% for team in form.teams.field.queryset %}
                            <option value="{{ team.id }}" {% if team in form.teams.value %}selected{% endif %}>{{ team.name }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>Select a workspace first to see available teams</option>
                    {% endif %}
                </select>
                {% if form.teams.help_text %}
                    <p class="text-[10px] text-zinc-500 dark:text-gray-500 mt-1">{{ form.teams.help_text }}</p>
                {% endif %}
                {% if form.teams.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ form.teams.errors.0 }}</p>
                {% endif %}
            </div>

            <div class="pt-4 flex gap-3">
                <button type="submit" id="submitBtn" class="flex-1 bg-zinc-900 dark:bg-white text-white dark:text-black font-bold py-2.5 rounded hover:bg-zinc-800 dark:hover:bg-gray-200 transition-colors uppercase tracking-wider text-xs">
                    Save Product
                </button>
                <a href="{% url 'product_list' %}" class="px-4 py-2.5 rounded border border-zinc-300 dark:border-zinc-700 text-zinc-600 dark:text-gray-400 hover:text-zinc-900 dark:hover:text-white hover:border-zinc-500 dark:hover:border-zinc-500 text-xs uppercase font-bold transition-all">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const workspaceSelect = document.querySelector('select[name="workspace"]');
    const teamsSelect = document.getElementById('id_teams') || document.querySelector('select[name="teams"]');
    
    if (workspaceSelect && teamsSelect) {
        // Store initially selected teams (if any)
        const initialSelectedTeams = Array.from(teamsSelect.selectedOptions).map(opt => opt.value);
        
        function loadTeams(workspaceId, preserveSelection = false) {
            // Don't clear if we're preserving selection and there are already options
            if (!preserveSelection || teamsSelect.options.length === 0) {
                // Clear teams selection but keep the select element structure
                while (teamsSelect.firstChild) {
                    teamsSelect.removeChild(teamsSelect.firstChild);
                }
            }
            
            if (workspaceId) {
                // Only show loading if we cleared the options
                if (teamsSelect.options.length === 0) {
                    const loadingOption = document.createElement('option');
                    loadingOption.value = '';
                    loadingOption.textContent = 'Loading teams...';
                    loadingOption.disabled = true;
                    teamsSelect.appendChild(loadingOption);
                }
                
                // Get CSRF token for API request
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                
                // Fetch teams for this workspace
                fetch(`/api/v1/teams/?workspace=${workspaceId}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrfToken || '',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401 || response.status === 403) {
                                throw new Error('Authentication required. Please refresh the page.');
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear loading option
                        while (teamsSelect.firstChild) {
                            teamsSelect.removeChild(teamsSelect.firstChild);
                        }
                        
                        // Populate teams dropdown
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(team => {
                                const option = document.createElement('option');
                                option.value = team.id;
                                option.textContent = team.name;
                                // Restore selection if preserving
                                if (preserveSelection && initialSelectedTeams.includes(team.id)) {
                                    option.selected = true;
                                }
                                teamsSelect.appendChild(option);
                            });
                        } else {
                            // No teams available - add a placeholder
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'No teams available for this workspace';
                            option.disabled = true;
                            teamsSelect.appendChild(option);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching teams:', error);
                        // Clear loading option
                        while (teamsSelect.firstChild) {
                            teamsSelect.removeChild(teamsSelect.firstChild);
                        }
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Error loading teams. Please try again.';
                        option.disabled = true;
                        teamsSelect.appendChild(option);
                    });
            } else {
                // No workspace selected - only clear if not preserving
                if (!preserveSelection) {
                    while (teamsSelect.firstChild) {
                        teamsSelect.removeChild(teamsSelect.firstChild);
                    }
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Select a workspace first';
                    option.disabled = true;
                    teamsSelect.appendChild(option);
                }
            }
        }
        
        workspaceSelect.addEventListener('change', function() {
            loadTeams(this.value, false); // Don't preserve when user changes workspace
        });
        
        // On initial load, if workspace is already selected, load teams
        if (workspaceSelect && workspaceSelect.value) {
            // Always load teams when workspace is selected to get latest from API
            loadTeams(workspaceSelect.value, false);
        } else if (teamsSelect && teamsSelect.options.length === 0) {
            // Show placeholder if no workspace selected
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Select a workspace first';
            option.disabled = true;
            teamsSelect.appendChild(option);
        }
    }
    
    // Add form submission handler to show loading state
    const form = document.getElementById('productForm');
    const submitBtn = document.getElementById('submitBtn');
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            // Don't prevent default - let form submit normally
            // Just show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }
});
</script>
{% endblock %}