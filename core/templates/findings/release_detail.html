{% extends 'base.html' %}
{% load scanners %}

{% block breadcrumbs %}
<span class="text-zinc-500 dark:text-gray-600">/</span>
<a href="{% url 'product_detail' release.product.id %}" class="hover:text-zinc-900 dark:hover:text-white transition-colors">{{ release.product.name|lower }}</a>
<span class="text-zinc-500 dark:text-gray-600">/</span>
<span class="text-emerald-600 dark:text-emerald-400">{{ release.name }}</span>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="{% if message.tags == 'error' %}bg-red-50 dark:bg-red-500/10 border-red-200 dark:border-red-500/30 text-red-700 dark:text-red-400{% elif message.tags == 'success' %}bg-emerald-50 dark:bg-green-500/10 border-emerald-200 dark:border-green-500/30 text-emerald-700 dark:text-green-400{% else %}bg-blue-50 dark:bg-blue-500/10 border-blue-200 dark:border-blue-500/30 text-blue-700 dark:text-blue-400{% endif %} border rounded-lg px-4 py-3 text-sm shadow-sm">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="mb-6 border-b border-zinc-200 dark:border-zinc-800 pb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-zinc-900 dark:text-white mb-1">{{ release.name }}</h1>
                <div class="flex items-center gap-4 text-xs font-mono text-zinc-500 dark:text-gray-500">
                    <span class="bg-gradient-to-r from-zinc-100 to-zinc-200 dark:from-zinc-900 dark:to-zinc-800 px-2 py-1 rounded-lg border border-zinc-300 dark:border-zinc-800 shadow-sm">
                        SHA: {{ release.commit_hash|default:"HEAD" }}
                    </span>
                    <span>Created {{ release.created_at|date:"M d, Y H:i" }}</span>
                </div>
            </div>
            
            <a href="{% url 'upload_scan' %}?release_id={{ release.id }}" class="bg-gradient-to-r from-zinc-900 to-zinc-800 dark:from-white dark:to-gray-100 text-white dark:text-black text-xs font-bold px-4 py-2 rounded-lg hover:from-zinc-800 hover:to-zinc-700 dark:hover:from-gray-100 dark:hover:to-gray-200 transition-all uppercase tracking-wider shadow-md">
                + Add Scan
            </a>
        </div>
    </div>

    <div class="flex items-center gap-6 border-b border-zinc-200 dark:border-zinc-800 mb-8">
        <button onclick="switchTab('summary')" id="btn-summary" class="pb-3 text-sm font-bold border-b-2 transition-colors text-emerald-600 dark:text-emerald-500 border-emerald-600 dark:border-emerald-500">
            Summary
        </button>
        
        <button onclick="switchTab('vuln')" id="btn-vuln" class="pb-3 text-sm font-bold text-zinc-500 dark:text-gray-500 border-b-2 border-transparent hover:text-zinc-900 dark:hover:text-white transition-colors">
            Vulnerabilities
            <span class="ml-2 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-gray-400 px-1.5 py-0.5 rounded-lg text-[10px] shadow-sm">{{ vuln_stats.total }}</span>
        </button>
        
        <button onclick="switchTab('sbom')" id="btn-sbom" class="pb-3 text-sm font-bold text-zinc-500 dark:text-gray-500 border-b-2 border-transparent hover:text-zinc-900 dark:hover:text-white transition-colors">
            SBOM & Compliance
            <span class="ml-2 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-gray-400 px-1.5 py-0.5 rounded-lg text-[10px] shadow-sm">{{ total_components }}</span>
        </button>

        <button onclick="switchTab('scans')" id="btn-scans" class="pb-3 text-sm font-bold text-zinc-500 dark:text-gray-500 border-b-2 border-transparent hover:text-zinc-900 dark:hover:text-white transition-colors">
            Scan History
            <span class="ml-2 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-gray-400 px-1.5 py-0.5 rounded-lg text-[10px] shadow-sm">{{ scans.count }}</span>
        </button>
    </div>

    <!-- Summary Tab (Zone 1, 2, 3) -->
    <div id="tab-summary" class="block animate-fade-in">
        <!-- Loading State -->
        <div id="summary-loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 dark:border-emerald-400"></div>
            <p class="text-zinc-600 dark:text-gray-400 mt-4">Loading release summary...</p>
        </div>

        <!-- Content (hidden until loaded) -->
        <div id="summary-content" class="hidden">
            <!-- Zone 1: The Verdict (Top Row) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Compliance Badge -->
                <div id="compliance-badge" class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-6 shadow-lg dark:shadow-none">
                    <div class="flex items-center gap-3 mb-2">
                        <div id="compliance-icon" class="w-8 h-8 rounded-full flex items-center justify-center">
                            <!-- Icon will be inserted by JS -->
                        </div>
                        <div>
                            <div id="compliance-text" class="text-lg font-bold text-zinc-900 dark:text-white"></div>
                            <div id="compliance-subtext" class="text-xs text-zinc-500 dark:text-gray-500"></div>
                        </div>
                    </div>
                </div>

                <!-- Health Grade -->
                <div id="health-grade" class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-6 shadow-lg dark:shadow-none">
                    <div class="mb-2">
                        <div class="text-xs text-zinc-500 dark:text-gray-500 uppercase font-bold tracking-widest mb-1">Risk Score</div>
                        <div id="risk-score" class="text-3xl font-bold"></div>
                    </div>
                    <div id="grade-badge" class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-bold shadow-sm"></div>
                </div>

                <!-- SLA Monitor -->
                <div id="sla-monitor" class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-6 shadow-lg dark:shadow-none">
                    <div class="mb-2">
                        <div class="text-xs text-zinc-500 dark:text-gray-500 uppercase font-bold tracking-widest mb-1">SLA Status</div>
                        <div id="sla-status" class="text-lg font-bold"></div>
                    </div>
                    <div id="sla-subtext" class="text-xs text-zinc-500 dark:text-gray-500"></div>
                </div>
            </div>

            <!-- High-Risk Dependencies Section -->
            <div id="toxic-components-section" class="mb-8">
                <h3 class="text-sm font-bold text-zinc-900 dark:text-white mb-4 uppercase tracking-wider">Critical Upgrade Path</h3>
                <p class="text-xs text-zinc-600 dark:text-gray-500 mb-4">The following components contain active exploits. Upgrading them will resolve the highest risk.</p>
                <div id="toxic-components-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Cards will be populated by JavaScript -->
                </div>
                <div id="toxic-components-empty" class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-12 text-center text-zinc-500 dark:text-gray-500 hidden shadow-lg dark:shadow-none">
                    No high-risk dependencies found. All components are up to date.
                </div>
            </div>

            <!-- License Compliance Section -->
            <div id="license-compliance-section" class="mb-8">
                <h3 class="text-sm font-bold text-zinc-900 dark:text-white mb-4 uppercase tracking-wider">License Compliance</h3>
                <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-6 shadow-lg dark:shadow-none">
                    <!-- Alert for violations -->
                    <div id="license-alert" class="hidden mb-4 p-4 rounded-lg border shadow-sm"></div>
                    
                    <!-- Stacked Bar Chart -->
                    <div class="mb-4">
                        <div id="license-chart" class="h-8 bg-zinc-200 dark:bg-zinc-900 rounded-lg overflow-hidden flex shadow-sm">
                            <!-- Segments will be populated by JavaScript -->
                        </div>
                        <div class="flex justify-between text-xs text-zinc-500 dark:text-gray-500 mt-2">
                            <span id="license-compliant-label">Permissive: 0</span>
                            <span id="license-violations-label">Copyleft/Forbidden: 0</span>
                            <span id="license-unknown-label">Unknown/None: 0</span>
                        </div>
                    </div>
                    
                    <!-- Total count -->
                    <div class="text-xs text-zinc-600 dark:text-gray-400">
                        Total Components: <span id="license-total" class="text-zinc-900 dark:text-white font-bold">0</span>
                    </div>
                </div>
            </div>

            <!-- Zone 2: The Kill List (Middle Section) -->
            <div class="mb-8">
                <h3 class="text-sm font-bold text-zinc-900 dark:text-white mb-4 uppercase tracking-wider">Blocking Issues (Kill List)</h3>
                <div id="kill-list-container" class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl overflow-hidden shadow-lg dark:shadow-none">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gradient-to-r from-zinc-50 to-white dark:from-black dark:to-zinc-900 text-[10px] uppercase font-mono text-zinc-500 dark:text-gray-500 border-b border-zinc-200 dark:border-zinc-800">
                            <tr>
                                <th class="px-6 py-3 w-20">Type</th>
                                <th class="px-6 py-3 w-48">Issue</th>
                                <th class="px-6 py-3">Affected Component</th>
                                <th class="px-6 py-3">Location</th>
                                <th class="px-6 py-3 w-48">Remediation</th>
                            </tr>
                        </thead>
                        <tbody id="kill-list-body" class="divide-y divide-zinc-200 dark:divide-zinc-800">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                    <div id="kill-list-empty" class="px-6 py-12 text-center text-zinc-500 dark:text-gray-500 hidden">
                        No blocking issues found. Release is compliant.
                    </div>
                </div>
            </div>

            <!-- Zone 3: Risk Treemap (Bottom Section) -->
            <div>
                <h3 class="text-sm font-bold text-zinc-900 dark:text-white mb-4 uppercase tracking-wider">Risk Treemap (Artifact Breakdown)</h3>
                <div id="risk-treemap" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Populated by JavaScript -->
                </div>
                <div id="treemap-empty" class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-12 text-center text-zinc-500 dark:text-gray-500 hidden shadow-lg dark:shadow-none">
                    No artifacts linked to this release.
                </div>
            </div>
        </div>
    </div>

    <div id="tab-vuln" class="block animate-fade-in">
        
        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="bg-red-50 dark:bg-red-500/5 border border-red-200 dark:border-red-500/20 p-4 rounded-xl shadow-sm">
                <div class="text-red-700 dark:text-red-500 text-[10px] uppercase font-bold tracking-widest mb-1">Critical</div>
                <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.critical }}</div>
            </div>
            <div class="bg-orange-50 dark:bg-orange-500/5 border border-orange-200 dark:border-orange-500/20 p-4 rounded-xl shadow-sm">
                <div class="text-orange-700 dark:text-orange-500 text-[10px] uppercase font-bold tracking-widest mb-1">High</div>
                <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.high }}</div>
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-500/5 border border-yellow-200 dark:border-yellow-500/20 p-4 rounded-xl shadow-sm">
                <div class="text-yellow-700 dark:text-yellow-500 text-[10px] uppercase font-bold tracking-widest mb-1">Medium</div>
                <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.medium }}</div>
            </div>
            <div class="bg-blue-50 dark:bg-blue-500/5 border border-blue-200 dark:border-blue-500/20 p-4 rounded-xl shadow-sm">
                <div class="text-blue-700 dark:text-blue-500 text-[10px] uppercase font-bold tracking-widest mb-1">Low</div>
                <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.low }}</div>
            </div>
             <div class="bg-zinc-50 dark:bg-gray-500/5 border border-zinc-200 dark:border-gray-500/20 p-4 rounded-xl shadow-sm">
                <div class="text-zinc-600 dark:text-gray-400 text-[10px] uppercase font-bold tracking-widest mb-1">Info</div>
                <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.info }}</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl p-4 mb-6 shadow-lg dark:shadow-none">
            <form method="get" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <input type="hidden" name="tab" value="vuln">
                <input type="hidden" name="vuln_per_page" value="{{ vuln_per_page }}">
                <div>
                    <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Status</label>
                    <select name="status" class="w-full bg-zinc-100 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm">
                        <option value="">All</option>
                        <option value="ACTIVE" {% if filters.status == 'ACTIVE' or filters.status == 'OPEN' %}selected{% endif %}>Active</option>
                        <option value="FIXED" {% if filters.status == 'FIXED' %}selected{% endif %}>Fixed</option>
                        <option value="FALSE_POSITIVE" {% if filters.status == 'FALSE_POSITIVE' %}selected{% endif %}>False Positive</option>
                        <option value="RISK_ACCEPTED" {% if filters.status == 'RISK_ACCEPTED' %}selected{% endif %}>Risk Accepted</option>
                        <option value="DUPLICATE" {% if filters.status == 'DUPLICATE' %}selected{% endif %}>Duplicate</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Severity</label>
                    <select name="severity" class="w-full bg-zinc-100 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm">
                        <option value="">All</option>
                        <option value="CRITICAL" {% if filters.severity == 'CRITICAL' %}selected{% endif %}>Critical</option>
                        <option value="HIGH" {% if filters.severity == 'HIGH' %}selected{% endif %}>High</option>
                        <option value="MEDIUM" {% if filters.severity == 'MEDIUM' %}selected{% endif %}>Medium</option>
                        <option value="LOW" {% if filters.severity == 'LOW' %}selected{% endif %}>Low</option>
                        <option value="INFO" {% if filters.severity == 'INFO' %}selected{% endif %}>Info</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Scanner</label>
                    <select name="scanner" class="w-full bg-zinc-100 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm">
                        <option value="">All</option>
                        {% for scanner in available_scanners %}
                        <option value="{{ scanner }}" {% if filters.scanner == scanner %}selected{% endif %}>{{ scanner }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">EPSS Score (Min)</label>
                    <input type="number" name="epss" value="{{ filters.epss|default:'' }}" placeholder="0.0-1.0" step="0.01" min="0" max="1" class="w-full bg-zinc-100 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white font-mono shadow-sm">
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">KEV Status</label>
                    <select name="kev" class="w-full bg-zinc-100 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm">
                        <option value="">All</option>
                        <option value="true" {% if filters.kev == 'true' or filters.kev == '1' %}selected{% endif %}>KEV Only</option>
                        <option value="false" {% if filters.kev == 'false' or filters.kev == '0' %}selected{% endif %}>Non-KEV</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">CVE ID</label>
                    <input type="text" name="cve_id" value="{{ filters.cve_id|default:'' }}" placeholder="CVE-2024-..." class="w-full bg-zinc-100 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white font-mono shadow-sm">
                </div>
                <div class="md:col-span-3 lg:col-span-6 flex gap-2">
                    <button type="submit" class="bg-gradient-to-r from-zinc-900 to-zinc-800 dark:from-white dark:to-gray-100 text-white dark:text-black text-xs font-bold px-4 py-2 rounded-lg hover:from-zinc-800 hover:to-zinc-700 dark:hover:from-gray-100 dark:hover:to-gray-200 transition-all uppercase tracking-wider shadow-md">
                        Apply Filters
                    </button>
                    <a href="{% url 'release_detail' release.id %}?tab=vuln" class="bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-white text-xs font-bold px-4 py-2 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-700 transition-colors uppercase tracking-wider shadow-sm">
                        Clear
                    </a>
                </div>
            </form>
        </div>

        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-xl overflow-hidden shadow-lg dark:shadow-none">
            <table class="w-full text-left text-sm">
                <thead class="bg-gradient-to-r from-zinc-50 to-white dark:from-black dark:to-zinc-900 text-[10px] uppercase font-mono text-zinc-500 dark:text-gray-500 border-b border-zinc-200 dark:border-zinc-800">
                    <tr>
                        <th class="px-6 py-3 w-32">Severity</th>
                        <th class="px-6 py-3 w-32">EPSS / Risk</th>
                        <th class="px-6 py-3 w-48">CVE ID</th>
                        <th class="px-6 py-3">Package / Component</th>
                        <th class="px-6 py-3 w-32">Scan Type</th>
                        <th class="px-6 py-3 w-48">Fix Version</th>
                        <th class="px-6 py-3 w-32">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-200 dark:divide-zinc-800">
                    {% for finding in findings %}
                    <tr onclick="openVulnerabilityModal('{{ finding.id }}')" class="hover:bg-gradient-to-r hover:from-zinc-50 hover:to-white dark:hover:bg-zinc-900/50 transition-all group cursor-pointer {% if finding.status == 'FIXED' %}opacity-60 bg-zinc-50/50 dark:bg-zinc-900/20{% endif %}">
                        
                        <!-- Severity (First Column) -->
                        <td class="px-6 py-3">
                            <div class="flex flex-col gap-1">
                                {% if finding.severity == 'CRITICAL' %}
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-red-500 via-red-600 to-red-700 dark:from-red-500/20 dark:via-red-600/20 dark:to-red-700/20 text-white dark:text-red-400 border border-red-400 dark:border-red-500/30 w-fit shadow-sm">CRITICAL</span>
                                {% elif finding.severity == 'HIGH' %}
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-orange-500 via-orange-600 to-orange-700 dark:from-orange-500/20 dark:via-orange-600/20 dark:to-orange-700/20 text-white dark:text-orange-400 border border-orange-400 dark:border-orange-500/30 w-fit shadow-sm">HIGH</span>
                                {% elif finding.severity == 'MEDIUM' %}
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-yellow-500 via-yellow-600 to-yellow-700 dark:from-yellow-500/20 dark:via-yellow-600/20 dark:to-yellow-700/20 text-white dark:text-yellow-400 border border-yellow-400 dark:border-yellow-500/30 w-fit shadow-sm">MEDIUM</span>
                                {% elif finding.severity == 'LOW' %}
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 dark:from-blue-500/20 dark:via-blue-600/20 dark:to-blue-700/20 text-white dark:text-blue-400 border border-blue-400 dark:border-blue-500/30 w-fit shadow-sm">LOW</span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border border-zinc-200 dark:border-gray-500/20 w-fit shadow-sm">INFO</span>
                                {% endif %}
                            </div>
                        </td>

                        <td class="px-6 py-3">
                            <div class="flex flex-col gap-1.5 w-full max-w-[120px]">
                                {% if finding.epss_score > 0 %}
                                <div class="flex items-center gap-2" title="Exploit Probability: {{ finding.epss_score }}">
                                    <div class="flex-1 h-1.5 bg-zinc-200 dark:bg-zinc-800 rounded-full overflow-hidden">
                                        <div class="h-full {% if finding.epss_score > 0.5 %}bg-red-600 dark:bg-red-500{% else %}bg-blue-600 dark:bg-blue-500{% endif %}" style="width: {% widthratio finding.epss_score 1 100 %}%"></div> 
                                    </div>
                                    <span class="text-[9px] font-mono text-zinc-600 dark:text-gray-400">{{ finding.epss_score|floatformat:3 }}</span>
                                </div>
                                {% endif %}

                                {% if finding.kev_status %}
                                <div class="inline-flex">
                                    <span class="px-2 py-1 rounded-lg text-[9px] font-bold bg-gradient-to-r from-red-600 to-red-700 dark:from-red-600 dark:to-red-700 text-white border border-red-500 shadow-md animate-pulse tracking-wider">KEV: EXPLOITED</span>
                                </div>
                                {% endif %}
                            </div>
                        </td>

                        <td class="px-6 py-3 font-mono text-zinc-900 dark:text-white group-hover:text-emerald-600 dark:group-hover:text-emerald-400">
                            {% if finding.vulnerability_id %}
                            <a href="https://nvd.nist.gov/vuln/detail/{{ finding.vulnerability_id }}" target="_blank" class="hover:underline">
                                {{ finding.vulnerability_id }}
                            </a>
                            {% else %}
                            <span class="text-zinc-500 dark:text-gray-600">{{ finding.vulnerability_id|default:"N/A" }}</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-3">
                            <div class="text-zinc-900 dark:text-gray-300">{{ finding.package_name }}</div>
                            <div class="text-[10px] text-zinc-600 dark:text-gray-600 font-mono">{{ finding.package_version }}</div>
                        </td>

                        <!-- Scan Type -->
                        <td class="px-6 py-3">
                            {% load scanners %}
                            <span class="text-xs text-zinc-600 dark:text-gray-400 font-mono">
                                {{ finding.scan.scanner_name|get_scanner_type }}
                            </span>
                        </td>

                        <td class="px-6 py-3 font-mono text-emerald-600 dark:text-emerald-500 font-semibold">{{ finding.fix_version|default:"-" }}</td>

                        <!-- Status (Last Column) -->
                        <td class="px-6 py-3">
                            <div class="flex flex-col gap-1">
                                {% if finding.status == 'FIXED' %}
                                     <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-emerald-500 to-emerald-600 dark:from-emerald-500/20 dark:to-emerald-600/20 text-white dark:text-emerald-400 border border-emerald-400 dark:border-emerald-500/30 w-fit shadow-sm">✓ FIXED</span>
                                {% elif finding.status == 'FALSE_POSITIVE' %}
                                     <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border border-zinc-200 dark:border-gray-500/20 w-fit shadow-sm">∅ FALSE POSITIVE</span>
                                {% elif finding.status == 'RISK_ACCEPTED' %}
                                     <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-500/20 dark:to-purple-600/20 text-white dark:text-purple-400 border border-purple-400 dark:border-purple-500/30 w-fit shadow-sm">⚠ ACCEPTED</span>
                                {% elif finding.status == 'DUPLICATE' %}
                                     <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-500/20 dark:to-orange-600/20 text-white dark:text-orange-400 border border-orange-400 dark:border-orange-500/30 w-fit shadow-sm">↻ DUPLICATE</span>
                                {% elif finding.status == 'ACTIVE' or finding.status == 'OPEN' %}
                                     <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-500/20 dark:to-blue-600/20 text-white dark:text-blue-400 border border-blue-400 dark:border-blue-500/30 w-fit shadow-sm">● ACTIVE</span>
                                {% else %}
                                     <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border border-zinc-200 dark:border-gray-500/20 w-fit shadow-sm">{{ finding.status }}</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="px-6 py-12 text-center text-zinc-500 dark:text-gray-500">No vulnerabilities found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="px-6 py-4 border-t border-zinc-800 bg-zinc-900/30 flex justify-between items-center">
                    <form method="get" id="vulnPaginationForm" class="flex items-center gap-2 text-xs text-gray-500">
                    <input type="hidden" name="tab" value="vuln">
                    {% if filters.status %}<input type="hidden" name="status" value="{{ filters.status }}">{% endif %}
                    {% if filters.severity %}<input type="hidden" name="severity" value="{{ filters.severity }}">{% endif %}
                    {% if filters.scanner %}<input type="hidden" name="scanner" value="{{ filters.scanner }}">{% endif %}
                    {% if filters.cve_id %}<input type="hidden" name="cve_id" value="{{ filters.cve_id }}">{% endif %}
                    {% if filters.epss %}<input type="hidden" name="epss" value="{{ filters.epss }}">{% endif %}
                    {% if filters.kev %}<input type="hidden" name="kev" value="{{ filters.kev }}">{% endif %}
                    <span>Show</span>
                    <select name="vuln_per_page" onchange="document.getElementById('vulnPaginationForm').submit()" class="bg-zinc-900 border border-zinc-700 text-white rounded px-2 py-1 outline-none focus:border-emerald-500">
                        <option value="20" {% if vuln_per_page == '20' %}selected{% endif %}>20</option>
                        <option value="50" {% if vuln_per_page == '50' %}selected{% endif %}>50</option>
                        <option value="100" {% if vuln_per_page == '100' %}selected{% endif %}>100</option>
                    </select>
                    <span>of {{ findings.paginator.count }} items</span>
                </form>

                <div class="flex items-center gap-2">
                    {% if findings.has_previous %}
                        <a href="?vuln_page={{ findings.previous_page_number }}&vuln_per_page={{ vuln_per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.severity %}&severity={{ filters.severity }}{% endif %}{% if filters.scanner %}&scanner={{ filters.scanner }}{% endif %}{% if filters.cve_id %}&cve_id={{ filters.cve_id }}{% endif %}{% if filters.epss %}&epss={{ filters.epss }}{% endif %}{% if filters.kev %}&kev={{ filters.kev }}{% endif %}&tab=vuln" class="px-3 py-1 bg-zinc-800 border border-zinc-700 text-white rounded hover:bg-zinc-700 text-xs transition-colors">Previous</a>
                    {% else %}
                        <span class="px-3 py-1 bg-zinc-900 border border-zinc-800 text-gray-600 rounded text-xs cursor-not-allowed">Previous</span>
                    {% endif %}
                    <span class="text-xs text-gray-500 font-mono">Page {{ findings.number }} / {{ findings.paginator.num_pages }}</span>
                    {% if findings.has_next %}
                        <a href="?vuln_page={{ findings.next_page_number }}&vuln_per_page={{ vuln_per_page }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.severity %}&severity={{ filters.severity }}{% endif %}{% if filters.scanner %}&scanner={{ filters.scanner }}{% endif %}{% if filters.cve_id %}&cve_id={{ filters.cve_id }}{% endif %}{% if filters.epss %}&epss={{ filters.epss }}{% endif %}{% if filters.kev %}&kev={{ filters.kev }}{% endif %}&tab=vuln" class="px-3 py-1 bg-zinc-800 border border-zinc-700 text-white rounded hover:bg-zinc-700 text-xs transition-colors">Next</a>
                    {% else %}
                        <span class="px-3 py-1 bg-zinc-900 border border-zinc-800 text-gray-600 rounded text-xs cursor-not-allowed">Next</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="tab-sbom" class="hidden animate-fade-in">
        
        <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] p-5 rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-emerald-500 dark:text-emerald-500 text-[10px] uppercase font-bold tracking-widest">FOSS</div>
                        <div class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">{{ lic_stats.foss }}</div>
                        <div class="text-xs text-zinc-500 dark:text-gray-500 mt-1">Open Source</div>
                    </div>
                    <svg class="w-5 h-5 text-emerald-500/50 dark:text-emerald-500/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </div>
            </div>
            <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] p-5 rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-purple-500 dark:text-purple-500 text-[10px] uppercase font-bold tracking-widest">COSS</div>
                        <div class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">{{ lic_stats.coss }}</div>
                        <div class="text-xs text-zinc-500 dark:text-gray-500 mt-1">Commercial / Proprietary</div>
                    </div>
                    <svg class="w-5 h-5 text-purple-500/50 dark:text-purple-500/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
            </div>
            <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] p-5 rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-zinc-500 dark:text-gray-500 text-[10px] uppercase font-bold tracking-widest">Unidentified</div>
                        <div class="text-2xl font-bold text-zinc-900 dark:text-white mt-1">{{ lic_stats.unidentified }}</div>
                        <div class="text-xs text-zinc-500 dark:text-gray-500 mt-1">Missing / Unknown</div>
                    </div>
                    <svg class="w-5 h-5 text-zinc-500/50 dark:text-gray-500/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
        </div>

        <!-- Filters for SBOM Components -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-4 mb-6">
            <form method="get" class="flex flex-wrap items-center gap-4">
                <input type="hidden" name="tab" value="sbom">
                <input type="hidden" name="per_page" value="{{ per_page }}">
                
                <div class="flex-1 min-w-[200px]">
                    <input type="text" name="sbom_search" value="{{ request.GET.sbom_search|default:'' }}" placeholder="Search components..." class="w-full bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-700 text-zinc-900 dark:text-white rounded-lg px-3 py-2 text-sm outline-none focus:border-emerald-500">
                </div>
                
                <div>
                    <select name="sbom_license" class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-700 text-zinc-900 dark:text-white rounded-lg px-3 py-2 text-sm outline-none focus:border-emerald-500">
                        <option value="">All Licenses</option>
                        {% for license in available_licenses %}
                        <option value="{{ license }}" {% if request.GET.sbom_license == license %}selected{% endif %}>{{ license }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <select name="sbom_status" class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-700 text-zinc-900 dark:text-white rounded-lg px-3 py-2 text-sm outline-none focus:border-emerald-500">
                        <option value="">All Status</option>
                        <option value="NEW" {% if request.GET.sbom_status == 'NEW' %}selected{% endif %}>New</option>
                        <option value="REMOVED" {% if request.GET.sbom_status == 'REMOVED' %}selected{% endif %}>Removed</option>
                        <option value="UNCHANGED" {% if request.GET.sbom_status == 'UNCHANGED' %}selected{% endif %}>Unchanged</option>
                    </select>
                </div>
                
                <button type="submit" class="bg-emerald-500 text-white text-xs font-bold px-4 py-2 rounded hover:bg-emerald-600 transition-colors">
                    Filter
                </button>
                
                {% if request.GET.sbom_search or request.GET.sbom_license or request.GET.sbom_status %}
                <a href="?tab=sbom&per_page={{ per_page }}" class="text-xs text-zinc-600 dark:text-gray-400 hover:text-zinc-900 dark:hover:text-white">
                    Clear
                </a>
                {% endif %}
            </form>
        </div>

        <div class="bg-zinc-100 dark:bg-zinc-900/50 border border-dashed border-zinc-300 dark:border-zinc-800 rounded-lg p-6 mb-6 hover:border-emerald-500/50 dark:hover:border-emerald-500/50 transition-colors">
            <div class="flex justify-between items-center">
                <form method="post" action="{% url 'release_sbom_upload' release.id %}" enctype="multipart/form-data" id="sbomUploadForm" class="flex items-center gap-3 flex-1">
                    {% csrf_token %}
                    <input type="file" name="sbom_file" id="sbomFileInput" accept=".json" required class="hidden">
                    <button type="button" onclick="document.getElementById('sbomFileInput').click()" class="bg-emerald-500 text-white text-xs font-bold px-4 py-2 rounded hover:bg-emerald-600 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        Upload SBOM
                    </button>
                    <span id="sbomFileName" class="text-xs text-zinc-600 dark:text-gray-400"></span>
                    <span class="text-[10px] text-zinc-500 dark:text-gray-500 font-mono ml-auto">Accepted: CycloneDX JSON</span>
                </form>
                <a href="{% url 'release_sbom_export' release.id %}" class="bg-zinc-800 dark:bg-zinc-800 text-white text-xs font-bold px-4 py-2 rounded border border-zinc-700 dark:border-zinc-700 hover:bg-zinc-700 dark:hover:bg-zinc-700 transition-colors flex items-center gap-2 ml-4">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download CycloneDX
                </a>
            </div>
        </div>
        
        <script>
            document.getElementById('sbomFileInput').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name;
                const fileNameSpan = document.getElementById('sbomFileName');
                if (fileName) {
                    fileNameSpan.textContent = 'Selected: ' + fileName;
                    fileNameSpan.classList.remove('hidden');
                    // Auto-submit form when file is selected
                    document.getElementById('sbomUploadForm').submit();
                } else {
                    fileNameSpan.textContent = '';
                }
            });
        </script>

        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg overflow-hidden">
            <table class="w-full text-left text-xs text-zinc-600 dark:text-gray-400">
                <thead class="bg-zinc-50 dark:bg-black text-[10px] uppercase font-mono text-zinc-500 dark:text-gray-500 border-b border-zinc-200 dark:border-zinc-800">
                    <tr>
                        <th class="px-6 py-3">Component</th>
                        <th class="px-6 py-3">Version</th>
                        <th class="px-6 py-3">Type</th>
                        <th class="px-6 py-3">License</th>
                        <th class="px-6 py-3">PURL</th>
                        <th class="px-6 py-3">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-200 dark:divide-zinc-800">
                    {% for comp in page_obj %}
                    <tr class="hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors">
                        <td class="px-6 py-3 font-bold text-zinc-900 dark:text-white">{{ comp.name }}</td>
                        <td class="px-6 py-3 font-mono text-emerald-600 dark:text-emerald-500">{{ comp.version }}</td>
                        <td class="px-6 py-3 text-zinc-600 dark:text-gray-400">{{ comp.type }}</td>
                        <td class="px-6 py-3">
                            {% if comp.license == 'Unknown' or not comp.license %}
                                <span class="text-zinc-500 dark:text-gray-600 italic">Unknown</span>
                            {% else %}
                                <span class="bg-zinc-100 dark:bg-zinc-900 px-2 py-1 rounded border border-zinc-200 dark:border-zinc-800 text-zinc-900 dark:text-white">{{ comp.license }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 font-mono text-[9px] text-zinc-500 dark:text-gray-600 truncate max-w-[150px]">{{ comp.purl }}</td>
                        <td class="px-6 py-3">
                            {% if comp.status == 'NEW' %}
                                <span class="bg-green-500/20 text-green-600 dark:text-green-400 text-[10px] font-bold px-2 py-1 rounded border border-green-500/30 uppercase">New</span>
                            {% elif comp.status == 'REMOVED' %}
                                <span class="bg-red-500/20 text-red-600 dark:text-red-400 text-[10px] font-bold px-2 py-1 rounded border border-red-500/30 uppercase">Removed</span>
                            {% else %}
                                <span class="text-zinc-500 dark:text-gray-500 text-[10px]">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="px-6 py-12 text-center text-zinc-500 dark:text-gray-500">No components found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="px-6 py-4 border-t border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/30 flex justify-between items-center">
                <form method="get" id="paginationForm" class="flex items-center gap-2 text-xs text-zinc-500 dark:text-gray-500">
                    <input type="hidden" name="tab" value="sbom"> 
                    <span>Show</span>
                    <select name="per_page" onchange="document.getElementById('paginationForm').submit()" class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-700 text-zinc-900 dark:text-white rounded px-2 py-1 outline-none focus:border-emerald-500">
                        <option value="20" {% if per_page == '20' %}selected{% endif %}>20</option>
                        <option value="50" {% if per_page == '50' %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                    </select>
                    <span>of {{ page_obj.paginator.count }} items</span>
                </form>

                <div class="flex items-center gap-2">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}&tab=sbom{% if request.GET.sbom_search %}&sbom_search={{ request.GET.sbom_search }}{% endif %}{% if request.GET.sbom_license %}&sbom_license={{ request.GET.sbom_license }}{% endif %}{% if request.GET.sbom_status %}&sbom_status={{ request.GET.sbom_status }}{% endif %}" class="px-3 py-1 bg-zinc-200 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 text-zinc-900 dark:text-white rounded hover:bg-zinc-300 dark:hover:bg-zinc-700 text-xs transition-colors">Previous</a>
                    {% else %}
                        <span class="px-3 py-1 bg-zinc-100 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 text-zinc-500 dark:text-gray-600 rounded text-xs cursor-not-allowed">Previous</span>
                    {% endif %}
                    <span class="text-xs text-zinc-500 dark:text-gray-500 font-mono">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}&tab=sbom{% if request.GET.sbom_search %}&sbom_search={{ request.GET.sbom_search }}{% endif %}{% if request.GET.sbom_license %}&sbom_license={{ request.GET.sbom_license }}{% endif %}{% if request.GET.sbom_status %}&sbom_status={{ request.GET.sbom_status }}{% endif %}" class="px-3 py-1 bg-zinc-200 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 text-zinc-900 dark:text-white rounded hover:bg-zinc-300 dark:hover:bg-zinc-700 text-xs transition-colors">Next</a>
                    {% else %}
                        <span class="px-3 py-1 bg-zinc-100 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 text-zinc-500 dark:text-gray-600 rounded text-xs cursor-not-allowed">Next</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div id="tab-scans" class="hidden animate-fade-in">
        
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg overflow-hidden">
            <div class="px-6 py-3 border-b border-zinc-200 dark:border-[#27272a] bg-zinc-50 dark:bg-zinc-900/30 flex justify-between items-center">
                <h3 class="text-xs font-bold text-zinc-900 dark:text-white uppercase tracking-wider">Executed Scans</h3>
            </div>

            <table class="w-full text-left text-sm text-zinc-600 dark:text-gray-400">
                <thead class="bg-zinc-50 dark:bg-black text-[10px] uppercase font-mono text-zinc-500 dark:text-gray-500 border-b border-zinc-200 dark:border-zinc-800">
                    <tr>
                        <th class="px-6 py-3 w-48">Scanner Source</th>
                        <th class="px-6 py-3 w-48">Executed At</th>
                        <th class="px-6 py-3 w-32">Findings Detected</th>
                        <th class="px-6 py-3 w-32 text-center">Status</th>
                        <th class="px-6 py-3 text-right">Context</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-200 dark:divide-zinc-800">
                    {% for scan in scans %}
                    <tr class="hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors">
                        
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="h-8 w-8 bg-zinc-100 dark:bg-zinc-900 rounded flex items-center justify-center border border-zinc-200 dark:border-zinc-800 text-zinc-900 dark:text-white">
                                    {% if 'Trivy' in scan.scanner_name %}
                                        <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    {% else %}
                                        <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path></svg>
                                    {% endif %}
                                </div>
                                <span class="font-bold text-zinc-900 dark:text-white">{{ scan.scanner_name }}</span>
                            </div>
                        </td>

                        <td class="px-6 py-4 font-mono text-xs text-zinc-600 dark:text-gray-400">
                            {{ scan.started_at|date:"Y-m-d H:i" }}
                        </td>

                        <td class="px-6 py-4">
                             <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-white border border-zinc-300 dark:border-zinc-700">
                                {{ scan.findings_count }}
                            </span>
                        </td>

                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-emerald-500/10 text-emerald-600 dark:text-emerald-500 border border-emerald-500/20">
                                COMPLETED
                            </span>
                        </td>
                        
                        <td class="px-6 py-4 text-right font-mono text-xs text-zinc-500 dark:text-gray-600">
                            {{ scan.id|slice:":8" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="px-6 py-12 text-center text-zinc-500 dark:text-gray-500">No scans executed.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    function switchTab(tabName) {
        // 1. Define Styles
        const inactiveClass = "pb-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-white transition-colors";
        const activeClass = "pb-3 text-sm font-bold border-b-2 transition-colors text-emerald-500 border-emerald-500";
        const buttons = ['btn-summary', 'btn-vuln', 'btn-sbom', 'btn-scans'];
        const tabs = ['tab-summary', 'tab-vuln', 'tab-sbom', 'tab-scans'];

        // 2. Reset All
        buttons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.className = inactiveClass;
        });
        tabs.forEach(id => {
            const tab = document.getElementById(id);
            if (tab) tab.classList.add('hidden');
        });

        // 3. Activate Selected
        const activeBtn = document.getElementById('btn-' + tabName);
        const activeTab = document.getElementById('tab-' + tabName);
        if (activeBtn) activeBtn.className = activeClass;
        if (activeTab) activeTab.classList.remove('hidden');

        // 4. Update URL
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);

        // 5. Load summary data if switching to summary tab
        if (tabName === 'summary' && !window.summaryDataLoaded) {
            loadSummaryData();
        }
    }

    // Load summary data from API
    function loadSummaryData() {
        const releaseId = '{{ release.id }}';
        const loadingEl = document.getElementById('summary-loading');
        const contentEl = document.getElementById('summary-content');

        fetch(`/api/v1/releases/${releaseId}/summary/`)
            .then(response => {
                if (!response.ok) {
                    // Handle HTTP error responses
                    return response.json().then(err => {
                        throw new Error(`HTTP ${response.status}: ${err.detail || err.message || 'Unknown error'}`);
                    }).catch(() => {
                        throw new Error(`HTTP ${response.status}: Failed to load release summary`);
                    });
                }
                return response.json();
            })
            .then(data => {
                window.summaryDataLoaded = true;
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                renderSummaryData(data);
            })
            .catch(error => {
                console.error('Error loading summary:', error);
                loadingEl.innerHTML = `<p class="text-red-400">Error loading release summary: ${error.message}</p>`;
            });
    }

    // Render summary data
    function renderSummaryData(data) {
        // Zone 1: Verdict Cards
        renderComplianceBadge(data);
        renderHealthGrade(data);
        renderSLAMonitor(data);

        // High-Risk Dependencies
        renderToxicComponents(data.toxic_components);

        // License Compliance
        renderLicenseCompliance(data.license_compliance);

        // Zone 2: Kill List
        renderKillList(data.kill_list);

        // Zone 3: Risk Treemap
        renderRiskTreemap(data.risk_treemap);
    }

    function renderComplianceBadge(data) {
        const badge = document.getElementById('compliance-badge');
        const icon = document.getElementById('compliance-icon');
        const text = document.getElementById('compliance-text');
        const subtext = document.getElementById('compliance-subtext');

        if (data.compliance_status) {
            icon.innerHTML = '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>';
            text.textContent = 'EU CRA COMPLIANT';
            text.className = 'text-lg font-bold text-green-500';
            subtext.textContent = 'No blocking issues';
            badge.className = 'bg-green-500/5 border border-green-500/20 rounded-lg p-6';
        } else {
            icon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
            text.textContent = 'NON-COMPLIANT';
            text.className = 'text-lg font-bold text-red-500';
            subtext.textContent = `${data.compliance_blocking_issues} blocking issue(s)`;
            badge.className = 'bg-red-500/5 border border-red-500/20 rounded-lg p-6';
        }
    }

    function renderHealthGrade(data) {
        const scoreEl = document.getElementById('risk-score');
        const gradeEl = document.getElementById('grade-badge');

        scoreEl.textContent = data.risk_score;
        
        let gradeColor, gradeBg;
        if (data.health_grade === 'A') {
            gradeColor = 'text-green-500';
            gradeBg = 'bg-green-500/10 border-green-500/20';
        } else if (data.health_grade === 'B') {
            gradeColor = 'text-blue-500';
            gradeBg = 'bg-blue-500/10 border-blue-500/20';
        } else if (data.health_grade === 'C') {
            gradeColor = 'text-yellow-500';
            gradeBg = 'bg-yellow-500/10 border-yellow-500/20';
        } else {
            gradeColor = 'text-red-500';
            gradeBg = 'bg-red-500/10 border-red-500/20';
        }

        scoreEl.className = `text-3xl font-bold ${gradeColor}`;
        gradeEl.textContent = `Grade: ${data.health_grade}`;
        gradeEl.className = `inline-flex items-center px-3 py-1 rounded text-sm font-bold border ${gradeColor} ${gradeBg}`;
    }

    function renderSLAMonitor(data) {
        const statusEl = document.getElementById('sla-status');
        const subtextEl = document.getElementById('sla-subtext');

        if (data.sla_breaches === 0) {
            statusEl.textContent = 'On Track';
            statusEl.className = 'text-lg font-bold text-green-500';
            subtextEl.textContent = 'No overdue criticals';
        } else {
            statusEl.textContent = 'SLA BREACHED';
            statusEl.className = 'text-lg font-bold text-red-500';
            subtextEl.textContent = `${data.sla_breaches} Critical(s) overdue (>7 days)`;
        }
    }

    function renderToxicComponents(toxicComponents) {
        const container = document.getElementById('toxic-components-container');
        const empty = document.getElementById('toxic-components-empty');
        const section = document.getElementById('toxic-components-section');

        if (!toxicComponents || toxicComponents.length === 0) {
            if (container) container.innerHTML = '';
            if (empty) empty.classList.remove('hidden');
            if (section) section.classList.add('hidden');
            return;
        }

        // Show section if it was hidden
        if (section) section.classList.remove('hidden');
        if (empty) empty.classList.add('hidden');
        if (!container) return;

        container.innerHTML = '';

        toxicComponents.forEach(comp => {
            const card = document.createElement('div');
            card.className = 'bg-red-950/20 border border-red-500/30 rounded-lg p-4 flex flex-col justify-between hover:border-red-500/50 transition-colors';

            const exploitText = comp.kev_count === 1 ? 'Known Exploit' : 'Known Exploits';
            const fixVersion = comp.fix_version && comp.fix_version !== 'Not available' 
                ? comp.fix_version 
                : 'Not available';

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-white text-lg">${escapeHtml(comp.package_name)}</h4>
                        <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded whitespace-nowrap">
                            ${comp.kev_count} ${exploitText.toUpperCase()}
                        </span>
                    </div>
                    <div class="text-zinc-400 font-mono text-xs mt-1">
                        Current: <span class="text-zinc-300">${escapeHtml(comp.package_version)}</span>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-red-500/20 flex items-center justify-between">
                    <span class="text-xs text-zinc-500">Remediation:</span>
                    <span class="text-emerald-400 font-mono font-bold text-sm flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                        ${escapeHtml(fixVersion)}
                    </span>
                </div>
            `;

            container.appendChild(card);
        });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderLicenseCompliance(licenseData) {
        const sectionEl = document.getElementById('license-compliance-section');
        
        if (!licenseData || !licenseData.total) {
            // Hide license section if no data
            if (sectionEl) sectionEl.classList.add('hidden');
            return;
        }
        
        // Show section if it was hidden
        if (sectionEl) sectionEl.classList.remove('hidden');

        const total = licenseData.total || 0;
        const compliant = licenseData.compliant || 0;
        const violations = licenseData.violations || [];
        const violationCount = licenseData.violation_count || 0;
        const unknown = licenseData.unknown || 0;

        // Update total
        document.getElementById('license-total').textContent = total;

        // Calculate percentages for the bar chart
        const compliantPercent = total > 0 ? (compliant / total) * 100 : 0;
        const violationPercent = total > 0 ? (violationCount / total) * 100 : 0;
        const unknownPercent = total > 0 ? (unknown / total) * 100 : 0;

        // Render stacked bar chart
        const chartEl = document.getElementById('license-chart');
        chartEl.innerHTML = '';

        // Green segment (Permissive)
        if (compliantPercent > 0) {
            const greenSegment = document.createElement('div');
            greenSegment.className = 'bg-green-500 h-full';
            greenSegment.style.width = `${compliantPercent}%`;
            greenSegment.title = `Permissive: ${compliant}`;
            chartEl.appendChild(greenSegment);
        }

        // Red segment (Copyleft/Forbidden)
        if (violationPercent > 0) {
            const redSegment = document.createElement('div');
            redSegment.className = 'bg-red-500 h-full';
            redSegment.style.width = `${violationPercent}%`;
            redSegment.title = `Copyleft/Forbidden: ${violationCount}`;
            chartEl.appendChild(redSegment);
        }

        // Grey segment (Unknown/None)
        if (unknownPercent > 0) {
            const greySegment = document.createElement('div');
            greySegment.className = 'bg-gray-500 h-full';
            greySegment.style.width = `${unknownPercent}%`;
            greySegment.title = `Unknown/None: ${unknown}`;
            chartEl.appendChild(greySegment);
        }

        // Update labels
        document.getElementById('license-compliant-label').textContent = `Permissive: ${compliant}`;
        document.getElementById('license-violations-label').textContent = `Copyleft/Forbidden: ${violationCount}`;
        document.getElementById('license-unknown-label').textContent = `Unknown/None: ${unknown}`;

        // Show alert if violations found
        const alertEl = document.getElementById('license-alert');
        if (violationCount > 0) {
            // Get unique forbidden licenses from violations
            const forbiddenLicenses = new Set();
            violations.forEach(v => {
                if (v.forbidden_licenses) {
                    v.forbidden_licenses.forEach(lic => forbiddenLicenses.add(lic));
                }
            });
            const licenseList = Array.from(forbiddenLicenses).join(', ');

            alertEl.className = 'mb-4 p-4 rounded-lg border border-red-500/50 bg-red-500/10';
            alertEl.innerHTML = `
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <div>
                        <div class="text-red-400 font-bold mb-1">${violationCount} Violation${violationCount > 1 ? 's' : ''} Found</div>
                        <div class="text-red-300 text-sm">Forbidden license${violationCount > 1 ? 's' : ''} detected: ${licenseList}</div>
                    </div>
                </div>
            `;
            alertEl.classList.remove('hidden');
        } else {
            alertEl.classList.add('hidden');
        }
    }

    function renderKillList(killList) {
        const tbody = document.getElementById('kill-list-body');
        const empty = document.getElementById('kill-list-empty');

        tbody.innerHTML = '';

        if (killList.length === 0) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        killList.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-zinc-900/50 transition-colors';
            
            // Type icon
            const typeIcon = item.type_icon === 'skull' 
                ? '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
                : '<svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>';

            row.innerHTML = `
                <td class="px-6 py-3">${typeIcon}</td>
                <td class="px-6 py-3 font-mono text-white">${item.issue}</td>
                <td class="px-6 py-3 text-gray-300">${item.affected_component}</td>
                <td class="px-6 py-3 text-gray-400 font-mono text-xs">${item.location}</td>
                <td class="px-6 py-3 text-emerald-400 font-mono text-xs">${item.remediation}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderRiskTreemap(treemap) {
        const container = document.getElementById('risk-treemap');
        const empty = document.getElementById('treemap-empty');

        container.innerHTML = '';

        if (treemap.length === 0) {
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');

        treemap.forEach(artifact => {
            const box = document.createElement('div');
            box.className = `bg-[#09090b] border-2 rounded-lg p-4 cursor-pointer hover:scale-105 transition-transform`;
            
            // Color based on max severity
            if (artifact.color === 'red') {
                box.className += ' border-red-500/50 bg-red-500/5';
            } else if (artifact.color === 'orange') {
                box.className += ' border-orange-500/50 bg-orange-500/5';
            } else if (artifact.color === 'yellow') {
                box.className += ' border-yellow-500/50 bg-yellow-500/5';
            } else {
                box.className += ' border-green-500/50 bg-green-500/5';
            }

            const tooltip = `${artifact.artifact_name}: ${artifact.critical} Critical, ${artifact.high} High, ${artifact.medium} Medium`;
            
            box.innerHTML = `
                <div class="font-bold text-white mb-2 truncate" title="${artifact.artifact_name}">${artifact.artifact_name}</div>
                <div class="text-xs text-gray-400 font-mono mb-3 truncate">${artifact.artifact_version}</div>
                <div class="flex flex-wrap gap-1 text-[10px]">
                    ${artifact.critical > 0 ? `<span class="bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded">${artifact.critical}C</span>` : ''}
                    ${artifact.high > 0 ? `<span class="bg-orange-500/20 text-orange-400 px-1.5 py-0.5 rounded">${artifact.high}H</span>` : ''}
                    ${artifact.medium > 0 ? `<span class="bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded">${artifact.medium}M</span>` : ''}
                    ${artifact.total === 0 ? '<span class="text-green-400">Clean</span>' : ''}
                </div>
            `;
            
            box.title = tooltip;
            container.appendChild(box);
        });
    }

    // Auto-run on page load
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        if (activeTab && ['summary', 'vuln', 'sbom', 'scans'].includes(activeTab)) {
            switchTab(activeTab);
        } else {
            // Default to summary tab if no tab specified
            switchTab('summary');
        }
    });
</script>

<!-- Include vulnerability modal (same as vulnerabilities_list) -->
{% include 'findings/vulnerability_modal.html' %}
{% endblock %}