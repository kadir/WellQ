{% extends 'base.html' %}
{% load scanners %}

{% block title %}Vulnerabilities{% endblock %}

{% block breadcrumbs %}
<span class="text-zinc-500 dark:text-gray-600">/</span>
<span class="text-emerald-600 dark:text-emerald-400">vulnerabilities</span>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <div class="mb-6 border-b border-zinc-200 dark:border-zinc-800 pb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-zinc-900 dark:text-white mb-1">All Vulnerabilities</h1>
                <div class="text-xs font-mono text-zinc-500 dark:text-gray-500 mt-2">
                    Comprehensive view of all security findings across all products
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-5 gap-4 mb-8">
        <div class="bg-red-50 dark:bg-red-500/5 border border-red-200 dark:border-red-500/20 p-4 rounded-lg shadow-sm dark:shadow-none">
            <div class="text-red-700 dark:text-red-500 text-[10px] uppercase font-bold tracking-widest mb-1">Critical</div>
            <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.critical }}</div>
        </div>
        <div class="bg-orange-50 dark:bg-orange-500/5 border border-orange-200 dark:border-orange-500/20 p-4 rounded-lg shadow-sm dark:shadow-none">
            <div class="text-orange-700 dark:text-orange-500 text-[10px] uppercase font-bold tracking-widest mb-1">High</div>
            <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.high }}</div>
        </div>
        <div class="bg-yellow-50 dark:bg-yellow-500/5 border border-yellow-200 dark:border-yellow-500/20 p-4 rounded-lg shadow-sm dark:shadow-none">
            <div class="text-yellow-700 dark:text-yellow-500 text-[10px] uppercase font-bold tracking-widest mb-1">Medium</div>
            <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.medium }}</div>
        </div>
        <div class="bg-blue-50 dark:bg-blue-500/5 border border-blue-200 dark:border-blue-500/20 p-4 rounded-lg shadow-sm dark:shadow-none">
            <div class="text-blue-700 dark:text-blue-500 text-[10px] uppercase font-bold tracking-widest mb-1">Low</div>
            <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.low }}</div>
        </div>
        <div class="bg-zinc-50 dark:bg-gray-500/5 border border-zinc-200 dark:border-gray-500/20 p-4 rounded-lg shadow-sm dark:shadow-none">
            <div class="text-zinc-600 dark:text-gray-400 text-[10px] uppercase font-bold tracking-widest mb-1">Info</div>
            <div class="text-2xl font-bold text-zinc-900 dark:text-white">{{ vuln_stats.info }}</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-4 mb-6 shadow-sm dark:shadow-none">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4">
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Status</label>
                <select name="status" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white">
                    <option value="">All</option>
                    <option value="ACTIVE" {% if filters.status == 'ACTIVE' or filters.status == 'OPEN' %}selected{% endif %}>Active</option>
                    <option value="FIXED" {% if filters.status == 'FIXED' %}selected{% endif %}>Fixed</option>
                    <option value="FALSE_POSITIVE" {% if filters.status == 'FALSE_POSITIVE' %}selected{% endif %}>False Positive</option>
                    <option value="RISK_ACCEPTED" {% if filters.status == 'RISK_ACCEPTED' %}selected{% endif %}>Risk Accepted</option>
                    <option value="DUPLICATE" {% if filters.status == 'DUPLICATE' %}selected{% endif %}>Duplicate</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Severity</label>
                <select name="severity" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white">
                    <option value="">All</option>
                    <option value="CRITICAL" {% if filters.severity == 'CRITICAL' %}selected{% endif %}>Critical</option>
                    <option value="HIGH" {% if filters.severity == 'HIGH' %}selected{% endif %}>High</option>
                    <option value="MEDIUM" {% if filters.severity == 'MEDIUM' %}selected{% endif %}>Medium</option>
                    <option value="LOW" {% if filters.severity == 'LOW' %}selected{% endif %}>Low</option>
                    <option value="INFO" {% if filters.severity == 'INFO' %}selected{% endif %}>Info</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Scanner</label>
                <select name="scanner" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white">
                    <option value="">All</option>
                    {% for scanner in available_scanners %}
                    <option value="{{ scanner }}" {% if filters.scanner == scanner %}selected{% endif %}>{{ scanner }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">EPSS Score (Min)</label>
                <input type="number" name="epss" value="{{ filters.epss|default:'' }}" placeholder="0.0-1.0" step="0.01" min="0" max="1" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white font-mono">
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">KEV Status</label>
                <select name="kev" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white">
                    <option value="">All</option>
                    <option value="true" {% if filters.kev == 'true' or filters.kev == '1' %}selected{% endif %}>KEV Only</option>
                    <option value="false" {% if filters.kev == 'false' or filters.kev == '0' %}selected{% endif %}>Non-KEV</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">CVE ID</label>
                <input type="text" name="cve_id" value="{{ filters.cve_id|default:'' }}" placeholder="CVE-2024-..." class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white font-mono">
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Product</label>
                <input type="text" name="product" value="{{ filters.product|default:'' }}" placeholder="Product name" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white">
            </div>
            <div>
                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-1">Workspace</label>
                <input type="text" name="workspace" value="{{ filters.workspace|default:'' }}" placeholder="Workspace name" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded px-3 py-2 text-sm text-zinc-900 dark:text-white">
            </div>
            <div class="md:col-span-4 lg:col-span-8 flex gap-2">
                <button type="submit" class="bg-zinc-900 dark:bg-white text-white dark:text-black text-xs font-bold px-4 py-2 rounded hover:bg-zinc-800 dark:hover:bg-gray-200 transition-colors uppercase tracking-wider">
                    Apply Filters
                </button>
                <a href="{% url 'vulnerabilities_list' %}" class="bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-white text-xs font-bold px-4 py-2 rounded hover:bg-zinc-300 dark:hover:bg-zinc-700 transition-colors uppercase tracking-wider">
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Vulnerabilities Table -->
    <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg overflow-hidden shadow-sm dark:shadow-none">
        <table class="w-full text-left text-sm text-zinc-600 dark:text-gray-400">
            <thead class="bg-zinc-50 dark:bg-black text-[10px] uppercase font-mono text-zinc-500 dark:text-gray-500">
                <tr>
                    <th class="px-6 py-3 w-32">Severity</th>
                    <th class="px-6 py-3 w-32">EPSS / Risk</th>
                    <th class="px-6 py-3 w-48">CVE ID</th>
                    <th class="px-6 py-3">Package / Component</th>
                    <th class="px-6 py-3 w-32">Scan Type</th>
                    <th class="px-6 py-3 w-48">Product / Release</th>
                    <th class="px-6 py-3 w-48">Fix Version</th>
                    <th class="px-6 py-3 w-32">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-zinc-200 dark:divide-zinc-800">
                {% for finding in findings %}
                <tr onclick="openVulnerabilityModal('{{ finding.id }}')" class="hover:bg-zinc-50 dark:hover:bg-zinc-900/50 transition-colors group cursor-pointer {% if finding.status == 'FIXED' %}opacity-60 bg-zinc-50/50 dark:bg-zinc-900/20{% endif %}">
                    
                    <!-- Severity (First Column) -->
                    <td class="px-6 py-3">
                        <div class="flex flex-col gap-1">
                            {% if finding.severity == 'CRITICAL' %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-red-500 via-red-600 to-red-700 dark:from-red-500/20 dark:via-red-600/20 dark:to-red-700/20 text-white dark:text-red-400 border border-red-400 dark:border-red-500/30 w-fit shadow-sm">CRITICAL</span>
                            {% elif finding.severity == 'HIGH' %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-orange-500 via-orange-600 to-orange-700 dark:from-orange-500/20 dark:via-orange-600/20 dark:to-orange-700/20 text-white dark:text-orange-400 border border-orange-400 dark:border-orange-500/30 w-fit shadow-sm">HIGH</span>
                            {% elif finding.severity == 'MEDIUM' %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-yellow-500 via-yellow-600 to-yellow-700 dark:from-yellow-500/20 dark:via-yellow-600/20 dark:to-yellow-700/20 text-white dark:text-yellow-400 border border-yellow-400 dark:border-yellow-500/30 w-fit shadow-sm">MEDIUM</span>
                            {% elif finding.severity == 'LOW' %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 dark:from-blue-500/20 dark:via-blue-600/20 dark:to-blue-700/20 text-white dark:text-blue-400 border border-blue-400 dark:border-blue-500/30 w-fit shadow-sm">LOW</span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border border-zinc-200 dark:border-gray-500/20 w-fit shadow-sm">INFO</span>
                            {% endif %}
                        </div>
                    </td>

                    <td class="px-6 py-3">
                        <div class="flex flex-col gap-1.5 w-full max-w-[120px]">
                            {% if finding.epss_score > 0 %}
                            <div class="flex items-center gap-2" title="Exploit Probability: {{ finding.epss_score }}">
                                <div class="flex-1 h-1.5 bg-zinc-200 dark:bg-zinc-800 rounded-full overflow-hidden">
                                    <div class="h-full {% if finding.epss_score > 0.5 %}bg-red-600 dark:bg-red-500{% else %}bg-blue-600 dark:bg-blue-500{% endif %}" style="width: {% widthratio finding.epss_score 1 100 %}%"></div> 
                                </div>
                                <span class="text-[9px] font-mono text-zinc-600 dark:text-gray-400">{{ finding.epss_score|floatformat:3 }}</span>
                            </div>
                            {% endif %}

                            {% if finding.kev_status %}
                            <div class="inline-flex">
                                <span class="px-2 py-1 rounded-lg text-[9px] font-bold bg-gradient-to-r from-red-600 to-red-700 dark:from-red-600 dark:to-red-700 text-white border border-red-500 shadow-md animate-pulse tracking-wider">KEV: EXPLOITED</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>

                    <td class="px-6 py-3 font-mono text-zinc-900 dark:text-white group-hover:text-emerald-600 dark:group-hover:text-emerald-400">
                        {% if finding.vulnerability_id %}
                        <a href="https://nvd.nist.gov/vuln/detail/{{ finding.vulnerability_id }}" target="_blank" class="hover:underline">
                            {{ finding.vulnerability_id }}
                        </a>
                        {% else %}
                        <span class="text-zinc-600 dark:text-gray-600">{{ finding.vulnerability_id|default:"N/A" }}</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-3">
                        <div class="text-zinc-900 dark:text-gray-300">{{ finding.package_name }}</div>
                        <div class="text-[10px] text-zinc-600 dark:text-gray-600 font-mono">{{ finding.package_version }}</div>
                    </td>

                    <!-- Scan Type -->
                    <td class="px-6 py-3">
                        <span class="text-xs text-zinc-600 dark:text-gray-400 font-mono">
                            {{ finding.scan.scanner_name|get_scanner_type }}
                        </span>
                    </td>

                    <td class="px-6 py-3">
                        <div class="text-zinc-900 dark:text-gray-300">
                            <a href="{% url 'product_detail' finding.scan.release.product.id %}" class="hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
                                {{ finding.scan.release.product.name }}
                            </a>
                        </div>
                        <div class="text-[10px] text-zinc-600 dark:text-gray-600 font-mono">
                            <a href="{% url 'release_detail' finding.scan.release.id %}" class="hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
                                {{ finding.scan.release.name }}
                            </a>
                        </div>
                        <div class="text-[9px] text-zinc-500 dark:text-gray-700 font-mono mt-1">
                            {{ finding.scan.release.product.workspace.name }}
                        </div>
                    </td>

                    <td class="px-6 py-3 font-mono text-emerald-600 dark:text-emerald-500 font-semibold">{{ finding.fix_version|default:"-" }}</td>

                    <!-- Status (Last Column) -->
                    <td class="px-6 py-3">
                        <div class="flex flex-col gap-1">
                            {% if finding.status == 'FIXED' %}
                                 <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-emerald-500 to-emerald-600 dark:from-emerald-500/20 dark:to-emerald-600/20 text-white dark:text-emerald-400 border border-emerald-400 dark:border-emerald-500/30 w-fit shadow-sm">✓ FIXED</span>
                            {% elif finding.status == 'FALSE_POSITIVE' %}
                                 <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border border-zinc-200 dark:border-gray-500/20 w-fit shadow-sm">∅ FALSE POSITIVE</span>
                            {% elif finding.status == 'RISK_ACCEPTED' %}
                                 <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-500/20 dark:to-purple-600/20 text-white dark:text-purple-400 border border-purple-400 dark:border-purple-500/30 w-fit shadow-sm">⚠ ACCEPTED</span>
                            {% elif finding.status == 'DUPLICATE' %}
                                 <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-500/20 dark:to-orange-600/20 text-white dark:text-orange-400 border border-orange-400 dark:border-orange-500/30 w-fit shadow-sm">↻ DUPLICATE</span>
                            {% elif finding.status == 'ACTIVE' or finding.status == 'OPEN' %}
                                 <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-500/20 dark:to-blue-600/20 text-white dark:text-blue-400 border border-blue-400 dark:border-blue-500/30 w-fit shadow-sm">● ACTIVE</span>
                            {% else %}
                                 <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border border-zinc-200 dark:border-gray-500/20 w-fit shadow-sm">{{ finding.status }}</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-zinc-500 dark:text-gray-500">
                        No vulnerabilities found.
                        {% if filters.status or filters.severity or filters.cve_id or filters.product or filters.workspace %}
                            <a href="{% url 'vulnerabilities_list' %}" class="text-emerald-600 dark:text-emerald-400 hover:underline ml-2">Clear filters</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if findings.has_other_pages %}
    <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-zinc-500 dark:text-gray-500">
            Showing {{ findings.start_index }} to {{ findings.end_index }} of {{ findings.paginator.count }} vulnerabilities
        </div>
        <div class="flex gap-2">
            {% if findings.has_previous %}
                <a href="?page={{ findings.previous_page_number }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.severity %}&severity={{ filters.severity }}{% endif %}{% if filters.scanner %}&scanner={{ filters.scanner }}{% endif %}{% if filters.cve_id %}&cve_id={{ filters.cve_id }}{% endif %}{% if filters.product %}&product={{ filters.product }}{% endif %}{% if filters.workspace %}&workspace={{ filters.workspace }}{% endif %}{% if filters.epss %}&epss={{ filters.epss }}{% endif %}{% if filters.kev %}&kev={{ filters.kev }}{% endif %}&per_page={{ per_page }}" 
                   class="bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-white px-4 py-2 rounded-lg text-sm hover:bg-zinc-300 dark:hover:bg-zinc-700 transition-colors shadow-sm">
                    Previous
                </a>
            {% endif %}
            {% if findings.has_next %}
                <a href="?page={{ findings.next_page_number }}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.severity %}&severity={{ filters.severity }}{% endif %}{% if filters.scanner %}&scanner={{ filters.scanner }}{% endif %}{% if filters.cve_id %}&cve_id={{ filters.cve_id }}{% endif %}{% if filters.product %}&product={{ filters.product }}{% endif %}{% if filters.workspace %}&workspace={{ filters.workspace }}{% endif %}{% if filters.epss %}&epss={{ filters.epss }}{% endif %}{% if filters.kev %}&kev={{ filters.kev }}{% endif %}&per_page={{ per_page }}" 
                   class="bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-white px-4 py-2 rounded-lg text-sm hover:bg-zinc-300 dark:hover:bg-zinc-700 transition-colors shadow-sm">
                    Next
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Per Page Selector -->
    <div class="mt-4 flex items-center gap-2 text-sm text-zinc-500 dark:text-gray-500">
        <span>Show:</span>
        <a href="?{% if filters.status %}status={{ filters.status }}&{% endif %}{% if filters.severity %}severity={{ filters.severity }}&{% endif %}{% if filters.scanner %}scanner={{ filters.scanner }}&{% endif %}{% if filters.cve_id %}cve_id={{ filters.cve_id }}&{% endif %}{% if filters.product %}product={{ filters.product }}&{% endif %}{% if filters.workspace %}workspace={{ filters.workspace }}&{% endif %}{% if filters.epss %}epss={{ filters.epss }}&{% endif %}{% if filters.kev %}kev={{ filters.kev }}&{% endif %}per_page=20" 
           class="{% if per_page == '20' %}text-zinc-900 dark:text-white font-bold{% else %}hover:text-zinc-900 dark:hover:text-white{% endif %}">20</a>
        <span>|</span>
        <a href="?{% if filters.status %}status={{ filters.status }}&{% endif %}{% if filters.severity %}severity={{ filters.severity }}&{% endif %}{% if filters.scanner %}scanner={{ filters.scanner }}&{% endif %}{% if filters.cve_id %}cve_id={{ filters.cve_id }}&{% endif %}{% if filters.product %}product={{ filters.product }}&{% endif %}{% if filters.workspace %}workspace={{ filters.workspace }}&{% endif %}{% if filters.epss %}epss={{ filters.epss }}&{% endif %}{% if filters.kev %}kev={{ filters.kev }}&{% endif %}per_page=50" 
           class="{% if per_page == '50' %}text-zinc-900 dark:text-white font-bold{% else %}hover:text-zinc-900 dark:hover:text-white{% endif %}">50</a>
        <span>|</span>
        <a href="?{% if filters.status %}status={{ filters.status }}&{% endif %}{% if filters.severity %}severity={{ filters.severity }}&{% endif %}{% if filters.scanner %}scanner={{ filters.scanner }}&{% endif %}{% if filters.cve_id %}cve_id={{ filters.cve_id }}&{% endif %}{% if filters.product %}product={{ filters.product }}&{% endif %}{% if filters.workspace %}workspace={{ filters.workspace }}&{% endif %}{% if filters.epss %}epss={{ filters.epss }}&{% endif %}{% if filters.kev %}kev={{ filters.kev }}&{% endif %}per_page=100" 
           class="{% if per_page == '100' %}text-zinc-900 dark:text-white font-bold{% else %}hover:text-zinc-900 dark:hover:text-white{% endif %}">100</a>
    </div>

</div>

<!-- Include vulnerability modal -->
{% include 'findings/vulnerability_modal.html' %}

{% endblock %}
