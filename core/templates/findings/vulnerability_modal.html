<!-- Vulnerability Detail Modal (Right Side Slide-in) -->
<div id="vulnModal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm" onclick="closeVulnerabilityModal()"></div>
    
    <!-- Modal Panel (Right Side) -->
    <div id="vulnModalPanel" class="absolute right-0 top-0 h-full w-full max-w-2xl bg-white dark:bg-[#09090b] border-l border-zinc-200 dark:border-[#27272a] shadow-2xl transform transition-transform duration-300 ease-out translate-x-full overflow-y-auto">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6 border-b border-zinc-200 dark:border-zinc-800 pb-4">
                <h2 class="text-2xl font-bold text-zinc-900 dark:text-white">Vulnerability Details</h2>
                <button onclick="closeVulnerabilityModal()" class="text-zinc-500 dark:text-gray-400 hover:text-zinc-900 dark:hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Loading State -->
            <div id="vulnModalLoading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 dark:border-emerald-400"></div>
                <p class="text-zinc-600 dark:text-gray-400 mt-4">Loading...</p>
            </div>
            
            <!-- Content -->
            <div id="vulnModalContent" class="hidden">
                <!-- CVE Header -->
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 id="vulnCVE" class="text-xl font-mono font-bold text-emerald-600 dark:text-emerald-400"></h3>
                        <span id="vulnSeverity" class="px-2.5 py-1 rounded-lg text-xs font-bold shadow-sm"></span>
                        <span id="vulnStatus" class="px-2.5 py-1 rounded-lg text-xs font-bold shadow-sm"></span>
                    </div>
                    <h4 id="vulnTitle" class="text-zinc-900 dark:text-white font-semibold"></h4>
                </div>
                
                <!-- Description -->
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-zinc-600 dark:text-gray-400 mb-2 uppercase tracking-wider">Description</h4>
                    <p id="vulnDescription" class="text-zinc-700 dark:text-gray-300 text-sm leading-relaxed"></p>
                </div>
                
                <!-- Package Info -->
                <div class="mb-6 grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-xs text-zinc-500 dark:text-gray-500 mb-1 uppercase">Package</h4>
                        <p id="vulnPackage" class="text-zinc-900 dark:text-white font-mono text-sm"></p>
                    </div>
                    <div>
                        <h4 class="text-xs text-zinc-500 dark:text-gray-500 mb-1 uppercase">Version</h4>
                        <p id="vulnVersion" class="text-zinc-900 dark:text-white font-mono text-sm"></p>
                    </div>
                    <div>
                        <h4 class="text-xs text-zinc-500 dark:text-gray-500 mb-1 uppercase">Fix Version</h4>
                        <p id="vulnFixVersion" class="text-emerald-600 dark:text-emerald-400 font-mono text-sm font-semibold"></p>
                    </div>
                    <div>
                        <h4 class="text-xs text-zinc-500 dark:text-gray-500 mb-1 uppercase">Scanner</h4>
                        <p id="vulnScanner" class="text-zinc-900 dark:text-white text-sm"></p>
                    </div>
                </div>
                
                <!-- Threat Intel -->
                <div class="mb-6 bg-gradient-to-r from-zinc-50 to-white dark:from-zinc-900/50 dark:to-zinc-900/30 border border-zinc-200 dark:border-zinc-800 rounded-lg p-4 shadow-sm">
                    <h4 class="text-sm font-bold text-zinc-600 dark:text-gray-400 mb-3 uppercase tracking-wider">Threat Intelligence</h4>
                    <div class="space-y-2">
                        <div id="vulnEPSS" class="flex items-center justify-between">
                            <span class="text-xs text-zinc-500 dark:text-gray-500">EPSS Score</span>
                            <span id="vulnEPSSValue" class="text-sm font-mono text-zinc-900 dark:text-white font-semibold"></span>
                        </div>
                        <div id="vulnKEV" class="hidden">
                            <span class="px-2.5 py-1 rounded-lg text-xs font-bold bg-gradient-to-r from-red-600 to-red-700 dark:from-red-600 dark:to-red-700 text-white border border-red-500 shadow-md">KEV: EXPLOITED</span>
                        </div>
                    </div>
                </div>
                
                <!-- Context -->
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-zinc-600 dark:text-gray-400 mb-3 uppercase tracking-wider">Context</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-zinc-500 dark:text-gray-500">Product:</span>
                            <a id="vulnProductLink" href="#" class="text-emerald-600 dark:text-emerald-400 hover:underline font-semibold"></a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-500 dark:text-gray-500">Release:</span>
                            <a id="vulnReleaseLink" href="#" class="text-emerald-600 dark:text-emerald-400 hover:underline font-semibold"></a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-500 dark:text-gray-500">Workspace:</span>
                            <span id="vulnWorkspace" class="text-zinc-900 dark:text-white"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-500 dark:text-gray-500">First Seen:</span>
                            <span id="vulnFirstSeen" class="text-zinc-900 dark:text-white font-mono text-xs"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-zinc-500 dark:text-gray-500">Last Seen:</span>
                            <span id="vulnLastSeen" class="text-zinc-900 dark:text-white font-mono text-xs"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Triage Info -->
                <div id="vulnTriageInfo" class="mb-6 hidden bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-500/10 dark:to-purple-600/10 border border-purple-200 dark:border-purple-500/20 rounded-lg p-4 shadow-sm">
                    <h4 class="text-sm font-bold text-purple-700 dark:text-purple-400 mb-2 uppercase tracking-wider">Triage Information</h4>
                    <p id="vulnTriageNote" class="text-zinc-700 dark:text-gray-300 text-sm mb-2"></p>
                    <div class="text-xs text-zinc-500 dark:text-gray-500">
                        By: <span id="vulnTriageBy" class="text-zinc-900 dark:text-white"></span> on <span id="vulnTriageAt" class="text-zinc-900 dark:text-white"></span>
                    </div>
                </div>
                
                <!-- Status Update Form -->
                <div class="border-t border-zinc-200 dark:border-zinc-800 pt-6">
                    <h4 class="text-sm font-bold text-zinc-600 dark:text-gray-400 mb-4 uppercase tracking-wider">Update Status</h4>
                    <form id="statusUpdateForm" onsubmit="updateVulnerabilityStatus(event)">
                        {% csrf_token %}
                        <input type="hidden" id="vulnId" name="finding_id">
                        
                        <div class="mb-4">
                            <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase">New Status</label>
                            <select id="newStatus" name="status" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm" onchange="handleStatusChange()">
                                <option value="ACTIVE">Active</option>
                                <option value="FIXED">Fixed</option>
                                <option value="RISK_ACCEPTED">Risk Accepted</option>
                                <option value="FALSE_POSITIVE">False Positive</option>
                                <option value="DUPLICATE">Duplicate</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase">Triage Note (Required for Risk Accepted / False Positive)</label>
                            <textarea id="triageNote" name="triage_note" rows="3" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm" placeholder="Reason for status change..."></textarea>
                        </div>
                        
                        <!-- Expiration Date (only for Risk Accepted) -->
                        <div id="expirationSection" class="mb-4 hidden">
                            <div class="mb-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="hasExpiration" name="has_expiration" class="w-4 h-4 bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded text-emerald-600 dark:text-emerald-500 focus:ring-emerald-600 dark:focus:ring-emerald-500 focus:ring-2" onchange="toggleExpirationDate()">
                                    <span class="text-xs text-zinc-500 dark:text-gray-500 uppercase">Set Expiration Date</span>
                                </label>
                            </div>
                            <div id="expirationDateInput" class="hidden">
                                <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase">Expiration Date</label>
                                <input type="date" id="expirationDate" name="expiration_date" class="w-full bg-white dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-900 dark:text-white shadow-sm" min="">
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 dark:from-emerald-500 dark:to-emerald-600 text-white dark:text-black text-xs font-bold px-4 py-2 rounded-lg hover:from-emerald-700 hover:to-emerald-800 dark:hover:from-emerald-600 dark:hover:to-emerald-700 transition-all uppercase tracking-wider shadow-md">
                            Update Status
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Only define these functions if they don't already exist
if (typeof openVulnerabilityModal === 'undefined') {
    let currentFindingId = null;

    function openVulnerabilityModal(findingId) {
        currentFindingId = findingId;
        const modal = document.getElementById('vulnModal');
        const panel = document.getElementById('vulnModalPanel');
        const loading = document.getElementById('vulnModalLoading');
        const content = document.getElementById('vulnModalContent');
        
        modal.classList.remove('hidden');
        content.classList.add('hidden');
        loading.classList.remove('hidden');
        
        // Slide in animation
        setTimeout(() => {
            panel.classList.remove('translate-x-full');
        }, 10);
        
        // Fetch vulnerability details
        fetch(`/vulnerabilities/${findingId}/detail/`)
            .then(response => response.json())
            .then(data => {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                populateModal(data);
            })
            .catch(error => {
                console.error('Error:', error);
                loading.innerHTML = '<p class="text-red-400">Error loading vulnerability details</p>';
            });
    }

    function closeVulnerabilityModal() {
        const modal = document.getElementById('vulnModal');
        const panel = document.getElementById('vulnModalPanel');
        
        panel.classList.add('translate-x-full');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function populateModal(data) {
        // Set basic info
        document.getElementById('vulnCVE').textContent = data.vulnerability_id || 'N/A';
        document.getElementById('vulnTitle').textContent = data.title;
        document.getElementById('vulnDescription').textContent = data.description || 'No description available.';
        document.getElementById('vulnPackage').textContent = data.package_name;
        document.getElementById('vulnVersion').textContent = data.package_version;
        document.getElementById('vulnFixVersion').textContent = data.fix_version || 'Not available';
        document.getElementById('vulnScanner').textContent = data.scanner_name;
        document.getElementById('vulnWorkspace').textContent = data.workspace_name;
        document.getElementById('vulnFirstSeen').textContent = data.first_seen;
        document.getElementById('vulnLastSeen').textContent = data.last_seen;
        document.getElementById('vulnId').value = data.id;
        
        // Set links
        document.getElementById('vulnProductLink').href = `/products/${data.product_id}/`;
        document.getElementById('vulnProductLink').textContent = data.product_name;
        document.getElementById('vulnReleaseLink').href = `/releases/${data.release_id}/`;
        document.getElementById('vulnReleaseLink').textContent = data.release_name;
        
        // Set severity badge
        const severityEl = document.getElementById('vulnSeverity');
        const severityColors = {
            'CRITICAL': 'bg-gradient-to-r from-red-500 via-red-600 to-red-700 dark:from-red-500/20 dark:via-red-600/20 dark:to-red-700/20 text-white dark:text-red-400 border-red-400 dark:border-red-500/30',
            'HIGH': 'bg-gradient-to-r from-orange-500 via-orange-600 to-orange-700 dark:from-orange-500/20 dark:via-orange-600/20 dark:to-orange-700/20 text-white dark:text-orange-400 border-orange-400 dark:border-orange-500/30',
            'MEDIUM': 'bg-gradient-to-r from-yellow-500 via-yellow-600 to-yellow-700 dark:from-yellow-500/20 dark:via-yellow-600/20 dark:to-yellow-700/20 text-white dark:text-yellow-400 border-yellow-400 dark:border-yellow-500/30',
            'LOW': 'bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 dark:from-blue-500/20 dark:via-blue-600/20 dark:to-blue-700/20 text-white dark:text-blue-400 border-blue-400 dark:border-blue-500/30',
            'INFO': 'bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border-zinc-200 dark:border-gray-500/20'
        };
        severityEl.className = `px-2.5 py-1 rounded-lg text-xs font-bold border shadow-sm ${severityColors[data.severity] || severityColors['INFO']}`;
        severityEl.textContent = data.severity;
        
        // Set status badge
        const statusEl = document.getElementById('vulnStatus');
        const statusColors = {
            'OPEN': 'bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-500/20 dark:to-blue-600/20 text-white dark:text-blue-400 border-blue-400 dark:border-blue-500/30',
            'FIXED': 'bg-gradient-to-r from-emerald-500 to-emerald-600 dark:from-emerald-500/20 dark:to-emerald-600/20 text-white dark:text-emerald-400 border-emerald-400 dark:border-emerald-500/30',
            'FALSE_POSITIVE': 'bg-zinc-100 dark:bg-gray-500/10 text-zinc-700 dark:text-gray-400 border-zinc-200 dark:border-gray-500/20',
            'WONT_FIX': 'bg-gradient-to-r from-purple-500 to-purple-600 dark:from-purple-500/20 dark:to-purple-600/20 text-white dark:text-purple-400 border-purple-400 dark:border-purple-500/30',
            'DUPLICATE': 'bg-gradient-to-r from-orange-500 to-orange-600 dark:from-orange-500/20 dark:to-orange-600/20 text-white dark:text-orange-400 border-orange-400 dark:border-orange-500/30'
        };
        statusEl.className = `px-2.5 py-1 rounded-lg text-xs font-bold border shadow-sm ${statusColors[data.status] || statusColors['OPEN']}`;
        statusEl.textContent = data.status.replace('_', ' ');
        
        // Set current status in form
        // Map backend status to frontend status
        const statusMapping = {
            'OPEN': 'ACTIVE',
            'WONT_FIX': 'RISK_ACCEPTED',
        };
        const frontendStatus = statusMapping[data.status] || data.status;
        document.getElementById('newStatus').value = frontendStatus;
        handleStatusChange(); // Update expiration section visibility
        
        // EPSS
        if (data.epss_score > 0) {
            document.getElementById('vulnEPSSValue').textContent = data.epss_score.toFixed(3);
            document.getElementById('vulnEPSS').classList.remove('hidden');
        } else {
            document.getElementById('vulnEPSS').classList.add('hidden');
        }
        
        // KEV
        if (data.kev_status) {
            document.getElementById('vulnKEV').classList.remove('hidden');
        } else {
            document.getElementById('vulnKEV').classList.add('hidden');
        }
        
        // Triage info
        if (data.triage_note) {
            document.getElementById('vulnTriageNote').textContent = data.triage_note;
            document.getElementById('vulnTriageBy').textContent = data.triage_by || 'Unknown';
            document.getElementById('vulnTriageAt').textContent = data.triage_at || 'Unknown';
            document.getElementById('vulnTriageInfo').classList.remove('hidden');
        } else {
            document.getElementById('vulnTriageInfo').classList.add('hidden');
        }
    }

    function handleStatusChange() {
        const status = document.getElementById('newStatus').value;
        const expirationSection = document.getElementById('expirationSection');
        
        if (status === 'RISK_ACCEPTED') {
            expirationSection.classList.remove('hidden');
        } else {
            expirationSection.classList.add('hidden');
            document.getElementById('hasExpiration').checked = false;
            toggleExpirationDate();
        }
    }
    
    function toggleExpirationDate() {
        const hasExpiration = document.getElementById('hasExpiration').checked;
        const expirationDateInput = document.getElementById('expirationDateInput');
        const expirationDate = document.getElementById('expirationDate');
        
        if (hasExpiration) {
            expirationDateInput.classList.remove('hidden');
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            expirationDate.min = today;
            // Set default to 30 days from now if empty
            if (!expirationDate.value) {
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + 30);
                expirationDate.value = futureDate.toISOString().split('T')[0];
            }
        } else {
            expirationDateInput.classList.add('hidden');
            expirationDate.value = '';
        }
    }

    function updateVulnerabilityStatus(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const findingId = formData.get('finding_id');
        const status = formData.get('status');
        const note = formData.get('triage_note');
        
        // Validate note for certain statuses
        if ((status === 'RISK_ACCEPTED' || status === 'FALSE_POSITIVE') && !note.trim()) {
            alert('Triage note is required for Risk Accepted and False Positive statuses.');
            return;
        }
        
        // Add expiration checkbox value
        const hasExpiration = document.getElementById('hasExpiration').checked;
        formData.set('has_expiration', hasExpiration.toString());
        
        // Validate expiration date if checkbox is checked
        if (status === 'RISK_ACCEPTED' && hasExpiration) {
            const expirationDate = formData.get('expiration_date');
            if (!expirationDate) {
                alert('Please select an expiration date or uncheck the expiration checkbox.');
                return;
            }
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                         getCookie('csrftoken');
        
        fetch(`/vulnerabilities/${findingId}/update-status/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the modal with updated data
                openVulnerabilityModal(findingId);
                // Optionally reload the page to update the list
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('Error updating status: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating status');
        });
    }

    // Helper function to get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeVulnerabilityModal();
        }
    });
}
</script>




