<!-- Vulnerability Detail Modal (Right Side Slide-in) -->
<div id="vulnModal" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80" onclick="closeVulnerabilityModal()"></div>
    
    <!-- Modal Panel (Right Side) -->
    <div id="vulnModalPanel" class="absolute right-0 top-0 h-full w-full max-w-2xl bg-[#09090b] border-l border-[#27272a] shadow-2xl transform transition-transform duration-300 ease-out translate-x-full overflow-y-auto">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6 border-b border-zinc-800 pb-4">
                <h2 class="text-2xl font-bold text-white">Vulnerability Details</h2>
                <button onclick="closeVulnerabilityModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Loading State -->
            <div id="vulnModalLoading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-400"></div>
                <p class="text-gray-400 mt-4">Loading...</p>
            </div>
            
            <!-- Content -->
            <div id="vulnModalContent" class="hidden">
                <!-- CVE Header -->
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 id="vulnCVE" class="text-xl font-mono font-bold text-emerald-400"></h3>
                        <span id="vulnSeverity" class="px-2 py-1 rounded text-xs font-bold"></span>
                        <span id="vulnStatus" class="px-2 py-1 rounded text-xs font-bold"></span>
                    </div>
                    <h4 id="vulnTitle" class="text-white font-semibold"></h4>
                </div>
                
                <!-- Description -->
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">Description</h4>
                    <p id="vulnDescription" class="text-gray-300 text-sm leading-relaxed"></p>
                </div>
                
                <!-- Package Info -->
                <div class="mb-6 grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-xs text-gray-500 mb-1 uppercase">Package</h4>
                        <p id="vulnPackage" class="text-white font-mono text-sm"></p>
                    </div>
                    <div>
                        <h4 class="text-xs text-gray-500 mb-1 uppercase">Version</h4>
                        <p id="vulnVersion" class="text-white font-mono text-sm"></p>
                    </div>
                    <div>
                        <h4 class="text-xs text-gray-500 mb-1 uppercase">Fix Version</h4>
                        <p id="vulnFixVersion" class="text-emerald-400 font-mono text-sm"></p>
                    </div>
                    <div>
                        <h4 class="text-xs text-gray-500 mb-1 uppercase">Scanner</h4>
                        <p id="vulnScanner" class="text-white text-sm"></p>
                    </div>
                </div>
                
                <!-- Threat Intel -->
                <div class="mb-6 bg-zinc-900/50 border border-zinc-800 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">Threat Intelligence</h4>
                    <div class="space-y-2">
                        <div id="vulnEPSS" class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">EPSS Score</span>
                            <span id="vulnEPSSValue" class="text-sm font-mono text-white"></span>
                        </div>
                        <div id="vulnKEV" class="hidden">
                            <span class="px-2 py-1 rounded text-xs font-bold bg-red-600 text-white border border-red-500">KEV: EXPLOITED</span>
                        </div>
                    </div>
                </div>
                
                <!-- Context -->
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">Context</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Product:</span>
                            <a id="vulnProductLink" href="#" class="text-emerald-400 hover:underline"></a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Release:</span>
                            <a id="vulnReleaseLink" href="#" class="text-emerald-400 hover:underline"></a>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Workspace:</span>
                            <span id="vulnWorkspace" class="text-white"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">First Seen:</span>
                            <span id="vulnFirstSeen" class="text-white font-mono text-xs"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Last Seen:</span>
                            <span id="vulnLastSeen" class="text-white font-mono text-xs"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Triage Info -->
                <div id="vulnTriageInfo" class="mb-6 hidden bg-purple-500/10 border border-purple-500/20 rounded-lg p-4">
                    <h4 class="text-sm font-bold text-purple-400 mb-2 uppercase tracking-wider">Triage Information</h4>
                    <p id="vulnTriageNote" class="text-gray-300 text-sm mb-2"></p>
                    <div class="text-xs text-gray-500">
                        By: <span id="vulnTriageBy" class="text-white"></span> on <span id="vulnTriageAt" class="text-white"></span>
                    </div>
                </div>
                
                <!-- Status Update Form -->
                <div class="border-t border-zinc-800 pt-6">
                    <h4 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">Update Status</h4>
                    <form id="statusUpdateForm" onsubmit="updateVulnerabilityStatus(event)">
                        {% csrf_token %}
                        <input type="hidden" id="vulnId" name="finding_id">
                        
                        <div class="mb-4">
                            <label class="block text-xs text-gray-500 mb-2 uppercase">New Status</label>
                            <select id="newStatus" name="status" class="w-full bg-black border border-zinc-800 rounded px-3 py-2 text-sm text-white">
                                <option value="ACTIVE">Active</option>
                                <option value="FIXED">Fixed</option>
                                <option value="RISK_ACCEPTED">Risk Accepted</option>
                                <option value="FALSE_POSITIVE">False Positive</option>
                                <option value="DUPLICATE">Duplicate</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-xs text-gray-500 mb-2 uppercase">Triage Note (Required for Risk Accepted / False Positive)</label>
                            <textarea id="triageNote" name="triage_note" rows="3" class="w-full bg-black border border-zinc-800 rounded px-3 py-2 text-sm text-white" placeholder="Reason for status change..."></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-emerald-500 text-black text-xs font-bold px-4 py-2 rounded hover:bg-emerald-400 transition-colors uppercase tracking-wider">
                            Update Status
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Only define these functions if they don't already exist
if (typeof openVulnerabilityModal === 'undefined') {
    let currentFindingId = null;

    function openVulnerabilityModal(findingId) {
        currentFindingId = findingId;
        const modal = document.getElementById('vulnModal');
        const panel = document.getElementById('vulnModalPanel');
        const loading = document.getElementById('vulnModalLoading');
        const content = document.getElementById('vulnModalContent');
        
        modal.classList.remove('hidden');
        content.classList.add('hidden');
        loading.classList.remove('hidden');
        
        // Slide in animation
        setTimeout(() => {
            panel.classList.remove('translate-x-full');
        }, 10);
        
        // Fetch vulnerability details
        fetch(`/vulnerabilities/${findingId}/detail/`)
            .then(response => response.json())
            .then(data => {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                populateModal(data);
            })
            .catch(error => {
                console.error('Error:', error);
                loading.innerHTML = '<p class="text-red-400">Error loading vulnerability details</p>';
            });
    }

    function closeVulnerabilityModal() {
        const modal = document.getElementById('vulnModal');
        const panel = document.getElementById('vulnModalPanel');
        
        panel.classList.add('translate-x-full');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function populateModal(data) {
        // Set basic info
        document.getElementById('vulnCVE').textContent = data.cve_id;
        document.getElementById('vulnTitle').textContent = data.title;
        document.getElementById('vulnDescription').textContent = data.description || 'No description available.';
        document.getElementById('vulnPackage').textContent = data.package_name;
        document.getElementById('vulnVersion').textContent = data.package_version;
        document.getElementById('vulnFixVersion').textContent = data.fixed_version;
        document.getElementById('vulnScanner').textContent = data.scanner_name;
        document.getElementById('vulnWorkspace').textContent = data.workspace_name;
        document.getElementById('vulnFirstSeen').textContent = data.first_seen;
        document.getElementById('vulnLastSeen').textContent = data.last_seen;
        document.getElementById('vulnId').value = data.id;
        
        // Set links
        document.getElementById('vulnProductLink').href = `/products/${data.product_id}/`;
        document.getElementById('vulnProductLink').textContent = data.product_name;
        document.getElementById('vulnReleaseLink').href = `/releases/${data.release_id}/`;
        document.getElementById('vulnReleaseLink').textContent = data.release_name;
        
        // Set severity badge
        const severityEl = document.getElementById('vulnSeverity');
        const severityColors = {
            'CRITICAL': 'bg-red-500/10 text-red-500 border-red-500/20',
            'HIGH': 'bg-orange-500/10 text-orange-500 border-orange-500/20',
            'MEDIUM': 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20',
            'LOW': 'bg-blue-500/10 text-blue-500 border-blue-500/20',
            'INFO': 'bg-gray-500/10 text-gray-400 border-gray-500/20'
        };
        severityEl.className = `px-2 py-1 rounded text-xs font-bold border ${severityColors[data.severity] || severityColors['INFO']}`;
        severityEl.textContent = data.severity;
        
        // Set status badge
        const statusEl = document.getElementById('vulnStatus');
        const statusColors = {
            'ACTIVE': 'bg-blue-500/10 text-blue-400 border-blue-500/20',
            'FIXED': 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20',
            'FALSE_POSITIVE': 'bg-gray-500/10 text-gray-400 border-gray-500/20',
            'RISK_ACCEPTED': 'bg-purple-500/10 text-purple-400 border-purple-500/20',
            'DUPLICATE': 'bg-orange-500/10 text-orange-400 border-orange-500/20'
        };
        statusEl.className = `px-2 py-1 rounded text-xs font-bold border ${statusColors[data.status] || statusColors['ACTIVE']}`;
        statusEl.textContent = data.status.replace('_', ' ');
        
        // Set current status in form
        document.getElementById('newStatus').value = data.status;
        
        // EPSS
        if (data.epss_score > 0) {
            document.getElementById('vulnEPSSValue').textContent = data.epss_score.toFixed(3);
            document.getElementById('vulnEPSS').classList.remove('hidden');
        } else {
            document.getElementById('vulnEPSS').classList.add('hidden');
        }
        
        // KEV
        if (data.kev_status) {
            document.getElementById('vulnKEV').classList.remove('hidden');
        } else {
            document.getElementById('vulnKEV').classList.add('hidden');
        }
        
        // Triage info
        if (data.triage_note) {
            document.getElementById('vulnTriageNote').textContent = data.triage_note;
            document.getElementById('vulnTriageBy').textContent = data.triage_by || 'Unknown';
            document.getElementById('vulnTriageAt').textContent = data.triage_at || 'Unknown';
            document.getElementById('vulnTriageInfo').classList.remove('hidden');
        } else {
            document.getElementById('vulnTriageInfo').classList.add('hidden');
        }
    }

    function updateVulnerabilityStatus(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const findingId = formData.get('finding_id');
        const status = formData.get('status');
        const note = formData.get('triage_note');
        
        // Validate note for certain statuses
        if ((status === 'RISK_ACCEPTED' || status === 'FALSE_POSITIVE') && !note.trim()) {
            alert('Triage note is required for Risk Accepted and False Positive statuses.');
            return;
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                         getCookie('csrftoken');
        
        fetch(`/vulnerabilities/${findingId}/update-status/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the modal with updated data
                openVulnerabilityModal(findingId);
                // Optionally reload the page to update the list
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('Error updating status: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating status');
        });
    }

    // Helper function to get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeVulnerabilityModal();
        }
    });
}
</script>

