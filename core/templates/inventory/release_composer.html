{% extends 'base.html' %}

{% block title %}Compose Release{% endblock %}

{% block breadcrumbs %}
<span class="text-gray-600">/</span>
<a href="{% url 'workspace_list' %}" class="hover:text-white">workspaces</a>
<span class="text-gray-600">/</span>
<a href="{% url 'workspace_detail' product.workspace.id %}" class="hover:text-white">{{ product.workspace.name|lower }}</a>
<span class="text-gray-600">/</span>
<a href="{% url 'product_detail' product.id %}" class="hover:text-white">{{ product.name|lower }}</a>
<span class="text-gray-600">/</span>
<span class="text-white">compose</span>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Compose New Release</h1>
        <p class="text-gray-500 text-sm">Select artifacts to bundle into this release</p>
    </div>

    <form method="POST" action="{% url 'release_composer' product.id %}" class="bg-zinc-900 border border-zinc-800 p-8 rounded-xl">
        {% csrf_token %}
        
        <div class="mb-6">
            <label class="text-xs text-zinc-500 uppercase font-mono mb-2 block">Release Tag</label>
            {{ form.name }}
            {% if form.name.errors %}
                <div class="text-red-500 text-xs mt-1">{{ form.name.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-4">
            <label class="text-xs text-zinc-500 uppercase font-mono mb-2 block">Bill of Materials (BOM)</label>
            
            <div class="relative mb-4">
                <input 
                    type="text" 
                    id="artifact-search" 
                    class="w-full bg-black border border-zinc-700 text-white p-3 rounded pl-10" 
                    placeholder="Search artifacts (e.g. backend:v1)..."
                    autocomplete="off"
                >
                <svg class="w-5 h-5 text-zinc-500 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>

            <div id="search-results" class="hidden absolute z-10 w-full bg-zinc-900 border border-zinc-700 rounded mt-1 max-h-64 overflow-y-auto"></div>

            <div id="selected-artifacts" class="mt-4 space-y-2 min-h-[100px]">
                <div class="text-sm text-zinc-600 italic text-center py-8" id="empty-state">
                    No artifacts selected. Search and select artifacts above.
                </div>
            </div>
        </div>

        <div class="mb-6">
            <label class="text-xs text-zinc-500 uppercase font-mono mb-2 block">Commit Hash (Optional)</label>
            {{ form.commit_hash }}
        </div>

        <div id="risk-preview" class="bg-zinc-950 border border-zinc-800 p-4 rounded mb-6 flex gap-4 items-center hidden">
            <div class="text-xs text-zinc-500">Estimated Risk:</div>
            <div id="risk-stats" class="flex gap-4">
                <!-- Risk stats will be populated by JavaScript -->
            </div>
        </div>

        <input type="hidden" name="artifact_ids" id="artifact-ids" value="">

        <div class="flex gap-3">
            <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded transition-colors">
                Publish Release
            </button>
            <a href="{% url 'product_detail' product.id %}" class="px-4 py-3 border border-zinc-700 rounded text-gray-300 hover:text-white hover:border-gray-500 transition-colors">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
let selectedArtifacts = [];
let searchTimeout = null;

// Artifact search
document.getElementById('artifact-search').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    const resultsDiv = document.getElementById('search-results');
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch(`{% url 'artifact_search_api' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.artifacts);
            })
            .catch(error => {
                console.error('Search error:', error);
            });
    }, 300);
});

function displaySearchResults(artifacts) {
    const resultsDiv = document.getElementById('search-results');
    
    if (artifacts.length === 0) {
        resultsDiv.innerHTML = '<div class="p-4 text-sm text-zinc-600 text-center">No artifacts found</div>';
        resultsDiv.classList.remove('hidden');
        return;
    }
    
    let html = '';
    artifacts.forEach(artifact => {
        const isSelected = selectedArtifacts.some(a => a.id === artifact.id);
        if (isSelected) return;
        
        html += `
            <div class="p-3 hover:bg-zinc-800 cursor-pointer border-b border-zinc-800 last:border-0" onclick="selectArtifact(${JSON.stringify(artifact).replace(/"/g, '&quot;')})">
                <div class="flex items-center gap-3">
                    <div class="h-8 w-8 bg-blue-500/20 rounded flex items-center justify-center text-blue-400 font-mono text-xs">
                        ${artifact.type.substring(0, 3).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <div class="text-sm text-white font-bold">${artifact.name}</div>
                        <div class="text-xs text-zinc-500 font-mono">${artifact.version}</div>
                    </div>
                    ${artifact.findings_count > 0 ? `<span class="text-xs text-red-500">${artifact.findings_count} findings</span>` : ''}
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
    resultsDiv.classList.remove('hidden');
}

function selectArtifact(artifact) {
    // Check if already selected
    if (selectedArtifacts.some(a => a.id === artifact.id)) {
        return;
    }
    
    selectedArtifacts.push(artifact);
    updateSelectedArtifacts();
    updateRiskPreview();
    
    // Clear search
    document.getElementById('artifact-search').value = '';
    document.getElementById('search-results').classList.add('hidden');
}

function removeArtifact(artifactId) {
    selectedArtifacts = selectedArtifacts.filter(a => a.id !== artifactId);
    updateSelectedArtifacts();
    updateRiskPreview();
}

function updateSelectedArtifacts() {
    const container = document.getElementById('selected-artifacts');
    const emptyState = document.getElementById('empty-state');
    
    if (selectedArtifacts.length === 0) {
        container.innerHTML = '<div class="text-sm text-zinc-600 italic text-center py-8" id="empty-state">No artifacts selected. Search and select artifacts above.</div>';
        return;
    }
    
    emptyState?.remove();
    
    let html = '';
    selectedArtifacts.forEach(artifact => {
        html += `
            <div class="flex justify-between items-center bg-zinc-800/50 border border-zinc-700 p-3 rounded group">
                <div class="flex items-center gap-3">
                    <div class="h-8 w-8 bg-blue-500/20 rounded flex items-center justify-center text-blue-400 font-mono text-xs">
                        ${artifact.type.substring(0, 3).toUpperCase()}
                    </div>
                    <div>
                        <div class="text-sm text-white font-bold">${artifact.name}</div>
                        <div class="text-xs text-zinc-500 font-mono">${artifact.version}</div>
                    </div>
                </div>
                <button type="button" onclick="removeArtifact('${artifact.id}')" class="text-zinc-500 hover:text-red-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update hidden input
    document.getElementById('artifact-ids').value = selectedArtifacts.map(a => a.id).join(',');
}

function updateRiskPreview() {
    const riskPreview = document.getElementById('risk-preview');
    const riskStats = document.getElementById('risk-stats');
    
    if (selectedArtifacts.length === 0) {
        riskPreview.classList.add('hidden');
        return;
    }
    
    const artifactIds = selectedArtifacts.map(a => a.id).join(',');
    
    fetch(`{% url 'release_composer_risk_preview' %}?artifact_ids=${artifactIds}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Risk preview error:', data.error);
                return;
            }
            
            riskStats.innerHTML = `
                ${data.critical > 0 ? `<div class="text-xs font-bold text-red-500">${data.critical} Critical</div>` : ''}
                ${data.high > 0 ? `<div class="text-xs font-bold text-orange-500">${data.high} High</div>` : ''}
                ${data.medium > 0 ? `<div class="text-xs font-bold text-yellow-500">${data.medium} Medium</div>` : ''}
                ${data.low > 0 ? `<div class="text-xs font-bold text-blue-500">${data.low} Low</div>` : ''}
                ${data.total === 0 ? `<div class="text-xs text-zinc-500">No findings</div>` : ''}
            `;
            
            riskPreview.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Risk preview error:', error);
        });
}

// Close search results when clicking outside
document.addEventListener('click', function(e) {
    const searchInput = document.getElementById('artifact-search');
    const resultsDiv = document.getElementById('search-results');
    
    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
        resultsDiv.classList.add('hidden');
    }
});
</script>
{% endblock %}



