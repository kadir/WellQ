{% extends 'base.html' %}

{% block title %}Profile Settings{% endblock %}

{% block breadcrumbs %}
<span class="text-zinc-500 dark:text-gray-600">/</span>
<span class="text-emerald-600 dark:text-emerald-400">profile</span>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <div class="mb-6 border-b border-zinc-200 dark:border-zinc-800 pb-6">
        <h1 class="text-3xl font-bold text-zinc-900 dark:text-white mb-1">Profile Settings</h1>
        <div class="text-xs font-mono text-zinc-500 dark:text-gray-500 mt-2">
            Manage your personal information and API tokens
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/20 text-red-700 dark:text-red-400{% else %}bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-200 dark:border-emerald-500/20 text-emerald-700 dark:text-emerald-400{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Theme Toggle Section -->
    <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 mb-8 shadow-sm dark:shadow-none">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white mb-2">Appearance</h2>
                <p class="text-sm text-zinc-500 dark:text-gray-500">Switch between light and dark theme</p>
            </div>
            <form method="post" action="{% url 'profile_settings' %}" class="flex items-center gap-4">
                {% csrf_token %}
                <input type="hidden" name="toggle_theme" value="1">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-zinc-700 dark:text-gray-300">Light</span>
                    <button type="submit" class="relative inline-flex h-6 w-11 items-center rounded-full bg-zinc-200 dark:bg-zinc-700 transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-600 dark:focus:ring-emerald-400 focus:ring-offset-2" role="switch" aria-checked="{% if current_theme == 'dark' %}true{% else %}false{% endif %}">
                        <span class="sr-only">Toggle theme</span>
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform {% if current_theme == 'dark' %}translate-x-6{% else %}translate-x-1{% endif %}"></span>
                    </button>
                    <span class="text-sm font-medium text-zinc-700 dark:text-gray-300">Dark</span>
                </div>
            </form>
        </div>
    </div>

    <!-- New Token Display (if just created) -->
    {% if request.session.new_token %}
    <div class="mb-6 bg-yellow-50 dark:bg-yellow-500/10 border border-yellow-200 dark:border-yellow-500/30 rounded-lg p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-bold text-yellow-700 dark:text-yellow-400 mb-2">⚠️ New API Token Created</h3>
                <p class="text-sm text-zinc-600 dark:text-gray-400 mb-4">Copy this token now - you won't be able to see it again!</p>
            </div>
            <form method="post" action="{% url 'profile_settings' %}">
                {% csrf_token %}
                <input type="hidden" name="dismiss_token" value="1">
                <button type="submit" class="text-zinc-600 dark:text-gray-400 hover:text-zinc-900 dark:hover:text-white">✕</button>
            </form>
        </div>
        <div class="bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded p-4 mb-4">
            <code class="text-emerald-600 dark:text-emerald-400 font-mono text-sm break-all">{{ request.session.new_token }}</code>
        </div>
        <button onclick="copyToken()" class="bg-emerald-600 dark:bg-emerald-500 text-white dark:text-black text-xs font-bold px-4 py-2 rounded hover:bg-emerald-700 dark:hover:bg-emerald-400 transition-colors uppercase tracking-wider">
            Copy Token
        </button>
    </div>
    {% endif %}

    <div class="space-y-8">
        
        <!-- Personal Information Section -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 shadow-sm dark:shadow-none">
            <h2 class="text-xl font-bold text-zinc-900 dark:text-white mb-6">Personal Information</h2>
            
            <form method="post" action="{% url 'profile_settings' %}">
                {% csrf_token %}
                <input type="hidden" name="update_profile" value="1">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">Username</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ form.username.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">Email</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ form.email.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">First Name</label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ form.first_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">Last Name</label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ form.last_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="submit" class="bg-zinc-900 dark:bg-white text-white dark:text-black text-xs font-bold px-6 py-2 rounded hover:bg-zinc-800 dark:hover:bg-gray-200 transition-colors uppercase tracking-wider">
                        Update Profile
                    </button>
                </div>
            </form>
        </div>

        <!-- Change Password Section -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 shadow-sm dark:shadow-none">
            <h2 class="text-xl font-bold text-zinc-900 dark:text-white mb-6">Change Password</h2>
            
            <form method="post" action="{% url 'profile_settings' %}">
                {% csrf_token %}
                <input type="hidden" name="change_password" value="1">
                
                <div class="space-y-4 max-w-md">
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">Current Password</label>
                        {{ password_form.old_password }}
                        {% if password_form.old_password.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ password_form.old_password.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">New Password</label>
                        {{ password_form.new_password1 }}
                        {% if password_form.new_password1.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ password_form.new_password1.errors }}</div>
                        {% endif %}
                        {% if password_form.new_password1.help_text %}
                            <div class="text-zinc-500 dark:text-gray-500 text-xs mt-1">{{ password_form.new_password1.help_text }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-xs text-zinc-500 dark:text-gray-500 mb-2 uppercase tracking-wider">Confirm New Password</label>
                        {{ password_form.new_password2 }}
                        {% if password_form.new_password2.errors %}
                            <div class="text-red-600 dark:text-red-400 text-xs mt-1">{{ password_form.new_password2.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mt-6">
                    <button type="submit" class="bg-zinc-900 dark:bg-white text-white dark:text-black text-xs font-bold px-6 py-2 rounded hover:bg-zinc-800 dark:hover:bg-gray-200 transition-colors uppercase tracking-wider">
                        Change Password
                    </button>
                </div>
            </form>
        </div>

        <!-- API Tokens Section -->
        <div class="bg-white dark:bg-[#09090b] border border-zinc-200 dark:border-[#27272a] rounded-lg p-6 shadow-sm dark:shadow-none">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-zinc-900 dark:text-white">API Tokens</h2>
                <a href="{% url 'create_api_token' %}" class="bg-emerald-600 dark:bg-emerald-500 text-white dark:text-black text-xs font-bold px-4 py-2 rounded hover:bg-emerald-700 dark:hover:bg-emerald-400 transition-colors uppercase tracking-wider">
                    + Create Token
                </a>
            </div>
            
            {% if api_tokens %}
            <div class="space-y-3">
                {% for token in api_tokens %}
                <div class="bg-zinc-50 dark:bg-black border border-zinc-200 dark:border-zinc-800 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-zinc-900 dark:text-white font-semibold">{{ token.name }}</h3>
                            {% if not token.is_active %}
                                <span class="px-2.5 py-0.5 rounded-md text-xs font-medium border bg-red-50 dark:bg-red-500/10 text-red-700 dark:text-red-400 border-red-200 dark:border-red-500/20">REVOKED</span>
                            {% elif token.is_expired %}
                                <span class="px-2.5 py-0.5 rounded-md text-xs font-medium border bg-orange-50 dark:bg-orange-500/10 text-orange-700 dark:text-orange-500 border-orange-200 dark:border-orange-500/20">EXPIRED</span>
                            {% else %}
                                <span class="px-2.5 py-0.5 rounded-md text-xs font-medium border bg-emerald-50 dark:bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 border-emerald-200 dark:border-emerald-500/20">ACTIVE</span>
                            {% endif %}
                        </div>
                        <div class="text-xs text-zinc-500 dark:text-gray-500 font-mono space-y-1">
                            <div>Preview: <span class="text-zinc-600 dark:text-gray-400">wq_{{ token.token_preview }}...</span></div>
                            <div>Created: {{ token.created_at|date:"M d, Y H:i" }}</div>
                            {% if token.last_used_at %}
                                <div>Last used: {{ token.last_used_at|date:"M d, Y H:i" }}</div>
                            {% else %}
                                <div>Last used: Never</div>
                            {% endif %}
                            {% if token.expires_at %}
                                <div>Expires: {{ token.expires_at|date:"M d, Y H:i" }}</div>
                            {% else %}
                                <div>Expires: Never</div>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        {% if token.is_active %}
                        <form method="post" action="{% url 'revoke_api_token' token.id %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" onclick="return confirm('Are you sure you want to revoke this token?')" 
                                    class="bg-red-50 dark:bg-red-500/10 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-500/20 text-xs font-bold px-3 py-1.5 rounded hover:bg-red-100 dark:hover:bg-red-500/20 transition-colors">
                                Revoke
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 text-zinc-500 dark:text-gray-500">
                <p class="mb-4">No API tokens created yet.</p>
                <a href="{% url 'create_api_token' %}" class="text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 underline">
                    Create your first API token
                </a>
            </div>
            {% endif %}
            
            <div class="mt-6 p-4 bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-800 rounded-lg">
                <h4 class="text-sm font-semibold text-zinc-900 dark:text-white mb-2">How to use API tokens:</h4>
                <div class="text-xs text-zinc-600 dark:text-gray-400 font-mono space-y-1">
                    <div>1. Copy your token after creation</div>
                    <div>2. Include it in API requests:</div>
                    <div class="ml-4 text-emerald-600 dark:text-emerald-400">Authorization: Token &lt;your-token&gt;</div>
                    <div class="mt-2">Example with curl:</div>
                    <div class="ml-4 bg-zinc-100 dark:bg-black p-2 rounded text-emerald-600 dark:text-emerald-400">
                        curl -H "Authorization: Token wq_..." https://api.example.com/api/v1/...
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<script>
function copyToken() {
    const token = '{{ request.session.new_token }}';
    navigator.clipboard.writeText(token).then(() => {
        alert('Token copied to clipboard!');
    });
}
</script>
{% endblock %}






